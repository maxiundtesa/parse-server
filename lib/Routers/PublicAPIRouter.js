"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.PublicAPIRouter = void 0;

var _PromiseRouter = _interopRequireDefault(require("../PromiseRouter"));

var _Config = _interopRequireDefault(require("../Config"));

var _express = _interopRequireDefault(require("express"));

var _path = _interopRequireDefault(require("path"));

var _fs = _interopRequireDefault(require("fs"));

var _querystring = _interopRequireDefault(require("querystring"));

var _node = require("parse/node");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const public_html = _path.default.resolve(__dirname, '../../public_html');

const views = _path.default.resolve(__dirname, '../../views');

class PublicAPIRouter extends _PromiseRouter.default {
  verifyEmail(req) {
    const {
      token,
      username,
      mail
    } = req.query;
    const appId = process.env.APP_ID || 'TicketFuchs';
    console.log(`AppID: ${appId}`);

    const config = _Config.default.get(appId);

    if (!config) {
      console.log('PublicApiRouter.js L. 18');
      this.invalidRequest();
    }

    if (!config.publicServerURL) {
      return this.missingPublicServerURL();
    }

    if (!token || !username || !mail) {
      console.log(`Mailadresse: ${mail}`);
      console.log('PublicApiRouter.js L. 28');
      return this.invalidLink(req);
    }

    const userController = config.userController;
    return userController.verifyEmail(username, token).then(() => {
      const params = _querystring.default.stringify({
        mail
      });

      return Promise.resolve({
        status: 302,
        location: `${config.verifyEmailSuccessURL}?${params}`
      });
    }, () => {
      return this.invalidVerificationLink(req);
    });
  }

  resendVerificationEmail(req) {
    console.log('Request' + JSON.stringify(req.body));
    const username = req.body.username;
    const appId = process.env.APP_ID || 'TicketFuchs';
    console.log(`AppID: ${appId}`);

    const config = _Config.default.get(appId);

    if (!config) {
      console.log('PublicApiRouter.js L. 51');
      this.invalidRequest();
    }

    if (!config.publicServerURL) {
      return this.missingPublicServerURL();
    }

    if (!username) {
      console.log('Username:' + username);
      console.log('PublicApiRouter.js L. 68');
      return this.invalidLink(req);
    }

    const userController = config.userController;
    return userController.resendVerificationEmail(username).then(() => {
      const params = _querystring.default.stringify({
        username
      });

      return Promise.resolve({
        status: 302,
        location: `${config.linkSendSuccessURL}?${params}`
      });
    }, () => {
      return Promise.resolve({
        status: 302,
        location: `${config.linkSendFailURL}`
      });
    });
  }

  changePassword(req) {
    return new Promise((resolve, reject) => {
      const appId = process.env.APP_ID || 'TicketFuchs';

      const config = _Config.default.get(appId);

      if (!config) {
        console.log('PublicApiRouter.js L. 95');
        this.invalidRequest();
      }

      if (!config.publicServerURL) {
        return resolve({
          status: 404,
          text: 'Not found.'
        });
      } // Should we keep the file in memory or leave like that?


      _fs.default.readFile(_path.default.resolve(views, 'choose_password'), 'utf-8', (err, data) => {
        if (err) {
          return reject(err);
        }

        data = data.replace('PARSE_SERVER_URL', `'${config.publicServerURL}'`);
        resolve({
          text: data
        });
      });
    });
  }

  requestResetPassword(req) {
    const appId = process.env.APP_ID || 'TicketFuchs';
    console.log(`AppID: ${appId}`);

    const config = _Config.default.get(appId);

    if (!config) {
      console.log('PublicApiRouter.js L. 120');
      this.invalidRequest();
    }

    if (!config.publicServerURL) {
      return this.missingPublicServerURL();
    }

    const {
      username,
      token,
      mail
    } = req.query;

    if (!username || !token || !mail) {
      console.log(`Mailadresse: ${mail}`);
      console.log('PublicApiRouter.js L. 28');
      return this.invalidLink(req);
    }

    return config.userController.checkResetTokenValidity(username, token).then(() => {
      const params = _querystring.default.stringify({
        token,
        mail: mail,
        id: config.applicationId,
        username,
        app: config.appName
      });

      return Promise.resolve({
        status: 302,
        location: `${config.choosePasswordURL}?${params}`
      });
    }, () => {
      return this.invalidLink(req);
    });
  }

  resetPassword(req) {
    const appId = process.env.APP_ID || 'TicketFuchs';
    console.log(`AppID: ${appId}`);

    const config = _Config.default.get(appId);

    if (!config) {
      console.log('PublicApiRouter.js L. 157');
      this.invalidRequest();
    }

    if (!config.publicServerURL) {
      return this.missingPublicServerURL();
    }

    const {
      username,
      token,
      new_password,
      mail
    } = req.body;

    if ((!username || !token || !new_password || !mail) && req.xhr === false) {
      console.log('PublicApiRouter.js L. 185');
      return this.invalidLink(req);
    }

    if (!username) {
      throw new _node.Parse.Error(_node.Parse.Error.USERNAME_MISSING, 'Missing username');
    }

    if (!token) {
      throw new _node.Parse.Error(_node.Parse.Error.OTHER_CAUSE, 'Missing token');
    }

    if (!new_password) {
      throw new _node.Parse.Error(_node.Parse.Error.PASSWORD_MISSING, 'Missing password');
    }

    if (!mail) {
      throw new _node.Parse.Error(_node.Parse.Error.EMAIL_MISSING, 'Missing Mail');
    }

    return config.userController.updatePassword(username, token, new_password).then(() => {
      return Promise.resolve({
        success: true
      });
    }, err => {
      return Promise.resolve({
        success: false,
        err
      });
    }).then(result => {
      const params = _querystring.default.stringify({
        username: username,
        token: token,
        id: config.applicationId,
        error: result.err,
        app: config.appName,
        mail: mail
      });

      if (req.xhr) {
        if (result.success) {
          return Promise.resolve({
            status: 200,
            response: 'Password successfully reset'
          });
        }

        if (result.err) {
          throw new _node.Parse.Error(_node.Parse.Error.OTHER_CAUSE, `${result.err}`);
        }
      }

      return Promise.resolve({
        status: 302,
        location: `${result.success ? `${config.passwordResetSuccessURL}?mail=${mail}` : `${config.choosePasswordURL}?${params}`}`
      });
    });
  }

  invalidLink(req) {
    var config = null;
    console.log('PublicApiRouter.js L. 215');
    console.log(`req: ${req}`);

    if (req === undefined) {
      const appId = process.env.APP_ID || 'TicketFuchs';
      console.log(`AppID: ${appId}`);
      config = _Config.default.get(appId);
      console.log(`config: ${config}`);
    } else {
      config = req.config;
      console.log(`config: ${config}`);
    }

    return Promise.resolve({
      status: 302,
      location: config.invalidLinkURL
    });
  }

  invalidVerificationLink(req) {
    var config = req.config;
    console.log('PublicApiRouter.js L. 235');
    console.log(`req: ${req}`);

    if (config === undefined) {
      const appId = process.env.APP_ID || 'TicketFuchs';
      console.log(`AppID: ${appId}`);
      config = _Config.default.get(appId);
      console.log(`config: ${config}`);
    }

    console.log(`config: ${config}`);

    if (req.query.username) {
      const params = _querystring.default.stringify({
        username: req.query.username
      });

      return Promise.resolve({
        status: 302,
        location: `${config.invalidVerificationLinkURL}?${params}`
      });
    } else {
      console.log('PublicApiRouter.js L. 253');
      return this.invalidLink(req);
    }
  }

  missingPublicServerURL() {
    return Promise.resolve({
      text: 'Not found.',
      status: 404
    });
  }

  invalidRequest() {
    const error = new Error();
    error.status = 403;
    error.message = 'unauthorized';
    throw error;
  }

  setConfig(req) {
    var seen = [];
    console.log(JSON.stringify(req, function (key, val) {
      if (val != null && typeof val == 'object') {
        if (seen.indexOf(val) >= 0) {
          return;
        }

        seen.push(val);
      }

      return val;
    }));
    const appId = process.env.APP_ID || 'TicketFuchs';
    req.config = _Config.default.get(appId);
    return Promise.resolve();
  }

  mountRoutes() {
    this.route('GET', '/verify_email', req => {
      this.setConfig(req);
    }, req => {
      return this.verifyEmail(req);
    });
    this.route('POST', '/resend_verification_email', req => {
      this.setConfig(req);
    }, req => {
      return this.resendVerificationEmail(req);
    });
    this.route('GET', '/choose_password', req => {
      return this.changePassword(req);
    });
    this.route('POST', '/request_password_reset', req => {
      this.setConfig(req);
    }, req => {
      return this.resetPassword(req);
    });
    this.route('GET', '/request_password_reset', req => {
      this.setConfig(req);
    }, req => {
      return this.requestResetPassword(req);
    });
  }

  expressRouter() {
    const router = _express.default.Router();

    router.use('/apps', _express.default.static(public_html));
    router.use('/', super.expressRouter());
    return router;
  }

}

exports.PublicAPIRouter = PublicAPIRouter;
var _default = PublicAPIRouter;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Sb3V0ZXJzL1B1YmxpY0FQSVJvdXRlci5qcyJdLCJuYW1lcyI6WyJwdWJsaWNfaHRtbCIsInBhdGgiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwidmlld3MiLCJQdWJsaWNBUElSb3V0ZXIiLCJQcm9taXNlUm91dGVyIiwidmVyaWZ5RW1haWwiLCJyZXEiLCJ0b2tlbiIsInVzZXJuYW1lIiwibWFpbCIsInF1ZXJ5IiwiYXBwSWQiLCJwcm9jZXNzIiwiZW52IiwiQVBQX0lEIiwiY29uc29sZSIsImxvZyIsImNvbmZpZyIsIkNvbmZpZyIsImdldCIsImludmFsaWRSZXF1ZXN0IiwicHVibGljU2VydmVyVVJMIiwibWlzc2luZ1B1YmxpY1NlcnZlclVSTCIsImludmFsaWRMaW5rIiwidXNlckNvbnRyb2xsZXIiLCJ0aGVuIiwicGFyYW1zIiwicXMiLCJzdHJpbmdpZnkiLCJQcm9taXNlIiwic3RhdHVzIiwibG9jYXRpb24iLCJ2ZXJpZnlFbWFpbFN1Y2Nlc3NVUkwiLCJpbnZhbGlkVmVyaWZpY2F0aW9uTGluayIsInJlc2VuZFZlcmlmaWNhdGlvbkVtYWlsIiwiSlNPTiIsImJvZHkiLCJsaW5rU2VuZFN1Y2Nlc3NVUkwiLCJsaW5rU2VuZEZhaWxVUkwiLCJjaGFuZ2VQYXNzd29yZCIsInJlamVjdCIsInRleHQiLCJmcyIsInJlYWRGaWxlIiwiZXJyIiwiZGF0YSIsInJlcGxhY2UiLCJyZXF1ZXN0UmVzZXRQYXNzd29yZCIsImNoZWNrUmVzZXRUb2tlblZhbGlkaXR5IiwiaWQiLCJhcHBsaWNhdGlvbklkIiwiYXBwIiwiYXBwTmFtZSIsImNob29zZVBhc3N3b3JkVVJMIiwicmVzZXRQYXNzd29yZCIsIm5ld19wYXNzd29yZCIsInhociIsIlBhcnNlIiwiRXJyb3IiLCJVU0VSTkFNRV9NSVNTSU5HIiwiT1RIRVJfQ0FVU0UiLCJQQVNTV09SRF9NSVNTSU5HIiwiRU1BSUxfTUlTU0lORyIsInVwZGF0ZVBhc3N3b3JkIiwic3VjY2VzcyIsInJlc3VsdCIsImVycm9yIiwicmVzcG9uc2UiLCJwYXNzd29yZFJlc2V0U3VjY2Vzc1VSTCIsInVuZGVmaW5lZCIsImludmFsaWRMaW5rVVJMIiwiaW52YWxpZFZlcmlmaWNhdGlvbkxpbmtVUkwiLCJtZXNzYWdlIiwic2V0Q29uZmlnIiwic2VlbiIsImtleSIsInZhbCIsImluZGV4T2YiLCJwdXNoIiwibW91bnRSb3V0ZXMiLCJyb3V0ZSIsImV4cHJlc3NSb3V0ZXIiLCJyb3V0ZXIiLCJleHByZXNzIiwiUm91dGVyIiwidXNlIiwic3RhdGljIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxNQUFNQSxXQUFXLEdBQUdDLGNBQUtDLE9BQUwsQ0FBYUMsU0FBYixFQUF3QixtQkFBeEIsQ0FBcEI7O0FBQ0EsTUFBTUMsS0FBSyxHQUFHSCxjQUFLQyxPQUFMLENBQWFDLFNBQWIsRUFBd0IsYUFBeEIsQ0FBZDs7QUFFTyxNQUFNRSxlQUFOLFNBQThCQyxzQkFBOUIsQ0FBNEM7QUFDakRDLEVBQUFBLFdBQVcsQ0FBQ0MsR0FBRCxFQUFNO0FBQ2YsVUFBTTtBQUFFQyxNQUFBQSxLQUFGO0FBQVNDLE1BQUFBLFFBQVQ7QUFBbUJDLE1BQUFBO0FBQW5CLFFBQTRCSCxHQUFHLENBQUNJLEtBQXRDO0FBQ0EsVUFBTUMsS0FBSyxHQUFHQyxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsTUFBWixJQUFzQixhQUFwQztBQUNBQyxJQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBYSxVQUFTTCxLQUFNLEVBQTVCOztBQUNBLFVBQU1NLE1BQU0sR0FBR0MsZ0JBQU9DLEdBQVAsQ0FBV1IsS0FBWCxDQUFmOztBQUVBLFFBQUksQ0FBQ00sTUFBTCxFQUFhO0FBQ1hGLE1BQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZLDBCQUFaO0FBQ0EsV0FBS0ksY0FBTDtBQUNEOztBQUVELFFBQUksQ0FBQ0gsTUFBTSxDQUFDSSxlQUFaLEVBQTZCO0FBQzNCLGFBQU8sS0FBS0Msc0JBQUwsRUFBUDtBQUNEOztBQUVELFFBQUksQ0FBQ2YsS0FBRCxJQUFVLENBQUNDLFFBQVgsSUFBdUIsQ0FBQ0MsSUFBNUIsRUFBa0M7QUFDaENNLE1BQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFhLGdCQUFlUCxJQUFLLEVBQWpDO0FBQ0FNLE1BQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZLDBCQUFaO0FBQ0EsYUFBTyxLQUFLTyxXQUFMLENBQWlCakIsR0FBakIsQ0FBUDtBQUNEOztBQUVELFVBQU1rQixjQUFjLEdBQUdQLE1BQU0sQ0FBQ08sY0FBOUI7QUFDQSxXQUFPQSxjQUFjLENBQUNuQixXQUFmLENBQTJCRyxRQUEzQixFQUFxQ0QsS0FBckMsRUFBNENrQixJQUE1QyxDQUNMLE1BQU07QUFDSixZQUFNQyxNQUFNLEdBQUdDLHFCQUFHQyxTQUFILENBQWE7QUFBRW5CLFFBQUFBO0FBQUYsT0FBYixDQUFmOztBQUNBLGFBQU9vQixPQUFPLENBQUM3QixPQUFSLENBQWdCO0FBQ3JCOEIsUUFBQUEsTUFBTSxFQUFFLEdBRGE7QUFFckJDLFFBQUFBLFFBQVEsRUFBRyxHQUFFZCxNQUFNLENBQUNlLHFCQUFzQixJQUFHTixNQUFPO0FBRi9CLE9BQWhCLENBQVA7QUFJRCxLQVBJLEVBUUwsTUFBTTtBQUNKLGFBQU8sS0FBS08sdUJBQUwsQ0FBNkIzQixHQUE3QixDQUFQO0FBQ0QsS0FWSSxDQUFQO0FBWUQ7O0FBRUQ0QixFQUFBQSx1QkFBdUIsQ0FBQzVCLEdBQUQsRUFBTTtBQUMzQlMsSUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVksWUFBWW1CLElBQUksQ0FBQ1AsU0FBTCxDQUFldEIsR0FBRyxDQUFDOEIsSUFBbkIsQ0FBeEI7QUFDQSxVQUFNNUIsUUFBUSxHQUFHRixHQUFHLENBQUM4QixJQUFKLENBQVM1QixRQUExQjtBQUNBLFVBQU1HLEtBQUssR0FBR0MsT0FBTyxDQUFDQyxHQUFSLENBQVlDLE1BQVosSUFBc0IsYUFBcEM7QUFDQUMsSUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQWEsVUFBU0wsS0FBTSxFQUE1Qjs7QUFFQSxVQUFNTSxNQUFNLEdBQUdDLGdCQUFPQyxHQUFQLENBQVdSLEtBQVgsQ0FBZjs7QUFFQSxRQUFJLENBQUNNLE1BQUwsRUFBYTtBQUNYRixNQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSwwQkFBWjtBQUNBLFdBQUtJLGNBQUw7QUFDRDs7QUFFRCxRQUFJLENBQUNILE1BQU0sQ0FBQ0ksZUFBWixFQUE2QjtBQUMzQixhQUFPLEtBQUtDLHNCQUFMLEVBQVA7QUFDRDs7QUFFRCxRQUFJLENBQUNkLFFBQUwsRUFBZTtBQUNiTyxNQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSxjQUFjUixRQUExQjtBQUNBTyxNQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSwwQkFBWjtBQUNBLGFBQU8sS0FBS08sV0FBTCxDQUFpQmpCLEdBQWpCLENBQVA7QUFDRDs7QUFFRCxVQUFNa0IsY0FBYyxHQUFHUCxNQUFNLENBQUNPLGNBQTlCO0FBRUEsV0FBT0EsY0FBYyxDQUFDVSx1QkFBZixDQUF1QzFCLFFBQXZDLEVBQWlEaUIsSUFBakQsQ0FDTCxNQUFNO0FBQ0osWUFBTUMsTUFBTSxHQUFHQyxxQkFBR0MsU0FBSCxDQUFhO0FBQUVwQixRQUFBQTtBQUFGLE9BQWIsQ0FBZjs7QUFDQSxhQUFPcUIsT0FBTyxDQUFDN0IsT0FBUixDQUFnQjtBQUNyQjhCLFFBQUFBLE1BQU0sRUFBRSxHQURhO0FBRXJCQyxRQUFBQSxRQUFRLEVBQUcsR0FBRWQsTUFBTSxDQUFDb0Isa0JBQW1CLElBQUdYLE1BQU87QUFGNUIsT0FBaEIsQ0FBUDtBQUlELEtBUEksRUFRTCxNQUFNO0FBQ0osYUFBT0csT0FBTyxDQUFDN0IsT0FBUixDQUFnQjtBQUNyQjhCLFFBQUFBLE1BQU0sRUFBRSxHQURhO0FBRXJCQyxRQUFBQSxRQUFRLEVBQUcsR0FBRWQsTUFBTSxDQUFDcUIsZUFBZ0I7QUFGZixPQUFoQixDQUFQO0FBSUQsS0FiSSxDQUFQO0FBZUQ7O0FBRURDLEVBQUFBLGNBQWMsQ0FBQ2pDLEdBQUQsRUFBTTtBQUNsQixXQUFPLElBQUl1QixPQUFKLENBQVksQ0FBQzdCLE9BQUQsRUFBVXdDLE1BQVYsS0FBcUI7QUFDdEMsWUFBTTdCLEtBQUssR0FBR0MsT0FBTyxDQUFDQyxHQUFSLENBQVlDLE1BQVosSUFBc0IsYUFBcEM7O0FBQ0EsWUFBTUcsTUFBTSxHQUFHQyxnQkFBT0MsR0FBUCxDQUFXUixLQUFYLENBQWY7O0FBRUEsVUFBSSxDQUFDTSxNQUFMLEVBQWE7QUFDWEYsUUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVksMEJBQVo7QUFDQSxhQUFLSSxjQUFMO0FBQ0Q7O0FBRUQsVUFBSSxDQUFDSCxNQUFNLENBQUNJLGVBQVosRUFBNkI7QUFDM0IsZUFBT3JCLE9BQU8sQ0FBQztBQUNiOEIsVUFBQUEsTUFBTSxFQUFFLEdBREs7QUFFYlcsVUFBQUEsSUFBSSxFQUFFO0FBRk8sU0FBRCxDQUFkO0FBSUQsT0FkcUMsQ0FldEM7OztBQUNBQyxrQkFBR0MsUUFBSCxDQUNFNUMsY0FBS0MsT0FBTCxDQUFhRSxLQUFiLEVBQW9CLGlCQUFwQixDQURGLEVBRUUsT0FGRixFQUdFLENBQUMwQyxHQUFELEVBQU1DLElBQU4sS0FBZTtBQUNiLFlBQUlELEdBQUosRUFBUztBQUNQLGlCQUFPSixNQUFNLENBQUNJLEdBQUQsQ0FBYjtBQUNEOztBQUNEQyxRQUFBQSxJQUFJLEdBQUdBLElBQUksQ0FBQ0MsT0FBTCxDQUNMLGtCQURLLEVBRUosSUFBRzdCLE1BQU0sQ0FBQ0ksZUFBZ0IsR0FGdEIsQ0FBUDtBQUlBckIsUUFBQUEsT0FBTyxDQUFDO0FBQ055QyxVQUFBQSxJQUFJLEVBQUVJO0FBREEsU0FBRCxDQUFQO0FBR0QsT0FkSDtBQWdCRCxLQWhDTSxDQUFQO0FBaUNEOztBQUVERSxFQUFBQSxvQkFBb0IsQ0FBQ3pDLEdBQUQsRUFBTTtBQUN4QixVQUFNSyxLQUFLLEdBQUdDLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxNQUFaLElBQXNCLGFBQXBDO0FBQ0FDLElBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFhLFVBQVNMLEtBQU0sRUFBNUI7O0FBQ0EsVUFBTU0sTUFBTSxHQUFHQyxnQkFBT0MsR0FBUCxDQUFXUixLQUFYLENBQWY7O0FBRUEsUUFBSSxDQUFDTSxNQUFMLEVBQWE7QUFDWEYsTUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVksMkJBQVo7QUFDQSxXQUFLSSxjQUFMO0FBQ0Q7O0FBRUQsUUFBSSxDQUFDSCxNQUFNLENBQUNJLGVBQVosRUFBNkI7QUFDM0IsYUFBTyxLQUFLQyxzQkFBTCxFQUFQO0FBQ0Q7O0FBRUQsVUFBTTtBQUFFZCxNQUFBQSxRQUFGO0FBQVlELE1BQUFBLEtBQVo7QUFBbUJFLE1BQUFBO0FBQW5CLFFBQTRCSCxHQUFHLENBQUNJLEtBQXRDOztBQUVBLFFBQUksQ0FBQ0YsUUFBRCxJQUFhLENBQUNELEtBQWQsSUFBdUIsQ0FBQ0UsSUFBNUIsRUFBa0M7QUFDaENNLE1BQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFhLGdCQUFlUCxJQUFLLEVBQWpDO0FBQ0FNLE1BQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZLDBCQUFaO0FBQ0EsYUFBTyxLQUFLTyxXQUFMLENBQWlCakIsR0FBakIsQ0FBUDtBQUNEOztBQUVELFdBQU9XLE1BQU0sQ0FBQ08sY0FBUCxDQUFzQndCLHVCQUF0QixDQUE4Q3hDLFFBQTlDLEVBQXdERCxLQUF4RCxFQUErRGtCLElBQS9ELENBQ0wsTUFBTTtBQUNKLFlBQU1DLE1BQU0sR0FBR0MscUJBQUdDLFNBQUgsQ0FBYTtBQUMxQnJCLFFBQUFBLEtBRDBCO0FBRTFCRSxRQUFBQSxJQUFJLEVBQUVBLElBRm9CO0FBRzFCd0MsUUFBQUEsRUFBRSxFQUFFaEMsTUFBTSxDQUFDaUMsYUFIZTtBQUkxQjFDLFFBQUFBLFFBSjBCO0FBSzFCMkMsUUFBQUEsR0FBRyxFQUFFbEMsTUFBTSxDQUFDbUM7QUFMYyxPQUFiLENBQWY7O0FBT0EsYUFBT3ZCLE9BQU8sQ0FBQzdCLE9BQVIsQ0FBZ0I7QUFDckI4QixRQUFBQSxNQUFNLEVBQUUsR0FEYTtBQUVyQkMsUUFBQUEsUUFBUSxFQUFHLEdBQUVkLE1BQU0sQ0FBQ29DLGlCQUFrQixJQUFHM0IsTUFBTztBQUYzQixPQUFoQixDQUFQO0FBSUQsS0FiSSxFQWNMLE1BQU07QUFDSixhQUFPLEtBQUtILFdBQUwsQ0FBaUJqQixHQUFqQixDQUFQO0FBQ0QsS0FoQkksQ0FBUDtBQWtCRDs7QUFFRGdELEVBQUFBLGFBQWEsQ0FBQ2hELEdBQUQsRUFBTTtBQUNqQixVQUFNSyxLQUFLLEdBQUdDLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxNQUFaLElBQXNCLGFBQXBDO0FBQ0FDLElBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFhLFVBQVNMLEtBQU0sRUFBNUI7O0FBQ0EsVUFBTU0sTUFBTSxHQUFHQyxnQkFBT0MsR0FBUCxDQUFXUixLQUFYLENBQWY7O0FBRUEsUUFBSSxDQUFDTSxNQUFMLEVBQWE7QUFDWEYsTUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVksMkJBQVo7QUFDQSxXQUFLSSxjQUFMO0FBQ0Q7O0FBRUQsUUFBSSxDQUFDSCxNQUFNLENBQUNJLGVBQVosRUFBNkI7QUFDM0IsYUFBTyxLQUFLQyxzQkFBTCxFQUFQO0FBQ0Q7O0FBRUQsVUFBTTtBQUFFZCxNQUFBQSxRQUFGO0FBQVlELE1BQUFBLEtBQVo7QUFBbUJnRCxNQUFBQSxZQUFuQjtBQUFpQzlDLE1BQUFBO0FBQWpDLFFBQTBDSCxHQUFHLENBQUM4QixJQUFwRDs7QUFFQSxRQUFJLENBQUMsQ0FBQzVCLFFBQUQsSUFBYSxDQUFDRCxLQUFkLElBQXVCLENBQUNnRCxZQUF4QixJQUF3QyxDQUFDOUMsSUFBMUMsS0FBbURILEdBQUcsQ0FBQ2tELEdBQUosS0FBWSxLQUFuRSxFQUEwRTtBQUN4RXpDLE1BQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZLDJCQUFaO0FBQ0EsYUFBTyxLQUFLTyxXQUFMLENBQWlCakIsR0FBakIsQ0FBUDtBQUNEOztBQUVELFFBQUksQ0FBQ0UsUUFBTCxFQUFlO0FBQ2IsWUFBTSxJQUFJaUQsWUFBTUMsS0FBVixDQUFnQkQsWUFBTUMsS0FBTixDQUFZQyxnQkFBNUIsRUFBOEMsa0JBQTlDLENBQU47QUFDRDs7QUFFRCxRQUFJLENBQUNwRCxLQUFMLEVBQVk7QUFDVixZQUFNLElBQUlrRCxZQUFNQyxLQUFWLENBQWdCRCxZQUFNQyxLQUFOLENBQVlFLFdBQTVCLEVBQXlDLGVBQXpDLENBQU47QUFDRDs7QUFFRCxRQUFJLENBQUNMLFlBQUwsRUFBbUI7QUFDakIsWUFBTSxJQUFJRSxZQUFNQyxLQUFWLENBQWdCRCxZQUFNQyxLQUFOLENBQVlHLGdCQUE1QixFQUE4QyxrQkFBOUMsQ0FBTjtBQUNEOztBQUVELFFBQUksQ0FBQ3BELElBQUwsRUFBVztBQUNULFlBQU0sSUFBSWdELFlBQU1DLEtBQVYsQ0FBZ0JELFlBQU1DLEtBQU4sQ0FBWUksYUFBNUIsRUFBMkMsY0FBM0MsQ0FBTjtBQUNEOztBQUVELFdBQU83QyxNQUFNLENBQUNPLGNBQVAsQ0FDSnVDLGNBREksQ0FDV3ZELFFBRFgsRUFDcUJELEtBRHJCLEVBQzRCZ0QsWUFENUIsRUFFSjlCLElBRkksQ0FHSCxNQUFNO0FBQ0osYUFBT0ksT0FBTyxDQUFDN0IsT0FBUixDQUFnQjtBQUNyQmdFLFFBQUFBLE9BQU8sRUFBRTtBQURZLE9BQWhCLENBQVA7QUFHRCxLQVBFLEVBUUhwQixHQUFHLElBQUk7QUFDTCxhQUFPZixPQUFPLENBQUM3QixPQUFSLENBQWdCO0FBQ3JCZ0UsUUFBQUEsT0FBTyxFQUFFLEtBRFk7QUFFckJwQixRQUFBQTtBQUZxQixPQUFoQixDQUFQO0FBSUQsS0FiRSxFQWVKbkIsSUFmSSxDQWVDd0MsTUFBTSxJQUFJO0FBQ2QsWUFBTXZDLE1BQU0sR0FBR0MscUJBQUdDLFNBQUgsQ0FBYTtBQUMxQnBCLFFBQUFBLFFBQVEsRUFBRUEsUUFEZ0I7QUFFMUJELFFBQUFBLEtBQUssRUFBRUEsS0FGbUI7QUFHMUIwQyxRQUFBQSxFQUFFLEVBQUVoQyxNQUFNLENBQUNpQyxhQUhlO0FBSTFCZ0IsUUFBQUEsS0FBSyxFQUFFRCxNQUFNLENBQUNyQixHQUpZO0FBSzFCTyxRQUFBQSxHQUFHLEVBQUVsQyxNQUFNLENBQUNtQyxPQUxjO0FBTTFCM0MsUUFBQUEsSUFBSSxFQUFFQTtBQU5vQixPQUFiLENBQWY7O0FBU0EsVUFBSUgsR0FBRyxDQUFDa0QsR0FBUixFQUFhO0FBQ1gsWUFBSVMsTUFBTSxDQUFDRCxPQUFYLEVBQW9CO0FBQ2xCLGlCQUFPbkMsT0FBTyxDQUFDN0IsT0FBUixDQUFnQjtBQUNyQjhCLFlBQUFBLE1BQU0sRUFBRSxHQURhO0FBRXJCcUMsWUFBQUEsUUFBUSxFQUFFO0FBRlcsV0FBaEIsQ0FBUDtBQUlEOztBQUNELFlBQUlGLE1BQU0sQ0FBQ3JCLEdBQVgsRUFBZ0I7QUFDZCxnQkFBTSxJQUFJYSxZQUFNQyxLQUFWLENBQWdCRCxZQUFNQyxLQUFOLENBQVlFLFdBQTVCLEVBQTBDLEdBQUVLLE1BQU0sQ0FBQ3JCLEdBQUksRUFBdkQsQ0FBTjtBQUNEO0FBQ0Y7O0FBRUQsYUFBT2YsT0FBTyxDQUFDN0IsT0FBUixDQUFnQjtBQUNyQjhCLFFBQUFBLE1BQU0sRUFBRSxHQURhO0FBRXJCQyxRQUFBQSxRQUFRLEVBQUcsR0FDVGtDLE1BQU0sQ0FBQ0QsT0FBUCxHQUNLLEdBQUUvQyxNQUFNLENBQUNtRCx1QkFBd0IsU0FBUTNELElBQUssRUFEbkQsR0FFSyxHQUFFUSxNQUFNLENBQUNvQyxpQkFBa0IsSUFBRzNCLE1BQU8sRUFDM0M7QUFOb0IsT0FBaEIsQ0FBUDtBQVFELEtBN0NJLENBQVA7QUE4Q0Q7O0FBRURILEVBQUFBLFdBQVcsQ0FBQ2pCLEdBQUQsRUFBTTtBQUNmLFFBQUlXLE1BQU0sR0FBRyxJQUFiO0FBQ0FGLElBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZLDJCQUFaO0FBQ0FELElBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFhLFFBQU9WLEdBQUksRUFBeEI7O0FBQ0EsUUFBSUEsR0FBRyxLQUFLK0QsU0FBWixFQUF1QjtBQUNyQixZQUFNMUQsS0FBSyxHQUFHQyxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsTUFBWixJQUFzQixhQUFwQztBQUNBQyxNQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBYSxVQUFTTCxLQUFNLEVBQTVCO0FBQ0FNLE1BQUFBLE1BQU0sR0FBR0MsZ0JBQU9DLEdBQVAsQ0FBV1IsS0FBWCxDQUFUO0FBQ0FJLE1BQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFhLFdBQVVDLE1BQU8sRUFBOUI7QUFDRCxLQUxELE1BS087QUFDTEEsTUFBQUEsTUFBTSxHQUFHWCxHQUFHLENBQUNXLE1BQWI7QUFDQUYsTUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQWEsV0FBVUMsTUFBTyxFQUE5QjtBQUNEOztBQUNELFdBQU9ZLE9BQU8sQ0FBQzdCLE9BQVIsQ0FBZ0I7QUFDckI4QixNQUFBQSxNQUFNLEVBQUUsR0FEYTtBQUVyQkMsTUFBQUEsUUFBUSxFQUFFZCxNQUFNLENBQUNxRDtBQUZJLEtBQWhCLENBQVA7QUFJRDs7QUFFRHJDLEVBQUFBLHVCQUF1QixDQUFDM0IsR0FBRCxFQUFNO0FBQzNCLFFBQUlXLE1BQU0sR0FBR1gsR0FBRyxDQUFDVyxNQUFqQjtBQUNBRixJQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSwyQkFBWjtBQUNBRCxJQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBYSxRQUFPVixHQUFJLEVBQXhCOztBQUNBLFFBQUlXLE1BQU0sS0FBS29ELFNBQWYsRUFBMEI7QUFDeEIsWUFBTTFELEtBQUssR0FBR0MsT0FBTyxDQUFDQyxHQUFSLENBQVlDLE1BQVosSUFBc0IsYUFBcEM7QUFDQUMsTUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQWEsVUFBU0wsS0FBTSxFQUE1QjtBQUNBTSxNQUFBQSxNQUFNLEdBQUdDLGdCQUFPQyxHQUFQLENBQVdSLEtBQVgsQ0FBVDtBQUNBSSxNQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBYSxXQUFVQyxNQUFPLEVBQTlCO0FBQ0Q7O0FBQ0RGLElBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFhLFdBQVVDLE1BQU8sRUFBOUI7O0FBQ0EsUUFBSVgsR0FBRyxDQUFDSSxLQUFKLENBQVVGLFFBQWQsRUFBd0I7QUFDdEIsWUFBTWtCLE1BQU0sR0FBR0MscUJBQUdDLFNBQUgsQ0FBYTtBQUMxQnBCLFFBQUFBLFFBQVEsRUFBRUYsR0FBRyxDQUFDSSxLQUFKLENBQVVGO0FBRE0sT0FBYixDQUFmOztBQUdBLGFBQU9xQixPQUFPLENBQUM3QixPQUFSLENBQWdCO0FBQ3JCOEIsUUFBQUEsTUFBTSxFQUFFLEdBRGE7QUFFckJDLFFBQUFBLFFBQVEsRUFBRyxHQUFFZCxNQUFNLENBQUNzRCwwQkFBMkIsSUFBRzdDLE1BQU87QUFGcEMsT0FBaEIsQ0FBUDtBQUlELEtBUkQsTUFRTztBQUNMWCxNQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSwyQkFBWjtBQUNBLGFBQU8sS0FBS08sV0FBTCxDQUFpQmpCLEdBQWpCLENBQVA7QUFDRDtBQUNGOztBQUVEZ0IsRUFBQUEsc0JBQXNCLEdBQUc7QUFDdkIsV0FBT08sT0FBTyxDQUFDN0IsT0FBUixDQUFnQjtBQUNyQnlDLE1BQUFBLElBQUksRUFBRSxZQURlO0FBRXJCWCxNQUFBQSxNQUFNLEVBQUU7QUFGYSxLQUFoQixDQUFQO0FBSUQ7O0FBRURWLEVBQUFBLGNBQWMsR0FBRztBQUNmLFVBQU04QyxLQUFLLEdBQUcsSUFBSVIsS0FBSixFQUFkO0FBQ0FRLElBQUFBLEtBQUssQ0FBQ3BDLE1BQU4sR0FBZSxHQUFmO0FBQ0FvQyxJQUFBQSxLQUFLLENBQUNNLE9BQU4sR0FBZ0IsY0FBaEI7QUFDQSxVQUFNTixLQUFOO0FBQ0Q7O0FBRURPLEVBQUFBLFNBQVMsQ0FBQ25FLEdBQUQsRUFBTTtBQUNiLFFBQUlvRSxJQUFJLEdBQUcsRUFBWDtBQUNBM0QsSUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQ0VtQixJQUFJLENBQUNQLFNBQUwsQ0FBZXRCLEdBQWYsRUFBb0IsVUFBU3FFLEdBQVQsRUFBY0MsR0FBZCxFQUFtQjtBQUNyQyxVQUFJQSxHQUFHLElBQUksSUFBUCxJQUFlLE9BQU9BLEdBQVAsSUFBYyxRQUFqQyxFQUEyQztBQUN6QyxZQUFJRixJQUFJLENBQUNHLE9BQUwsQ0FBYUQsR0FBYixLQUFxQixDQUF6QixFQUE0QjtBQUMxQjtBQUNEOztBQUNERixRQUFBQSxJQUFJLENBQUNJLElBQUwsQ0FBVUYsR0FBVjtBQUNEOztBQUNELGFBQU9BLEdBQVA7QUFDRCxLQVJELENBREY7QUFZQSxVQUFNakUsS0FBSyxHQUFHQyxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsTUFBWixJQUFzQixhQUFwQztBQUNBUixJQUFBQSxHQUFHLENBQUNXLE1BQUosR0FBYUMsZ0JBQU9DLEdBQVAsQ0FBV1IsS0FBWCxDQUFiO0FBQ0EsV0FBT2tCLE9BQU8sQ0FBQzdCLE9BQVIsRUFBUDtBQUNEOztBQUVEK0UsRUFBQUEsV0FBVyxHQUFHO0FBQ1osU0FBS0MsS0FBTCxDQUNFLEtBREYsRUFFRSxlQUZGLEVBR0UxRSxHQUFHLElBQUk7QUFDTCxXQUFLbUUsU0FBTCxDQUFlbkUsR0FBZjtBQUNELEtBTEgsRUFNRUEsR0FBRyxJQUFJO0FBQ0wsYUFBTyxLQUFLRCxXQUFMLENBQWlCQyxHQUFqQixDQUFQO0FBQ0QsS0FSSDtBQVdBLFNBQUswRSxLQUFMLENBQ0UsTUFERixFQUVFLDRCQUZGLEVBR0UxRSxHQUFHLElBQUk7QUFDTCxXQUFLbUUsU0FBTCxDQUFlbkUsR0FBZjtBQUNELEtBTEgsRUFNRUEsR0FBRyxJQUFJO0FBQ0wsYUFBTyxLQUFLNEIsdUJBQUwsQ0FBNkI1QixHQUE3QixDQUFQO0FBQ0QsS0FSSDtBQVdBLFNBQUswRSxLQUFMLENBQVcsS0FBWCxFQUFrQixrQkFBbEIsRUFBc0MxRSxHQUFHLElBQUk7QUFDM0MsYUFBTyxLQUFLaUMsY0FBTCxDQUFvQmpDLEdBQXBCLENBQVA7QUFDRCxLQUZEO0FBSUEsU0FBSzBFLEtBQUwsQ0FDRSxNQURGLEVBRUUseUJBRkYsRUFHRTFFLEdBQUcsSUFBSTtBQUNMLFdBQUttRSxTQUFMLENBQWVuRSxHQUFmO0FBQ0QsS0FMSCxFQU1FQSxHQUFHLElBQUk7QUFDTCxhQUFPLEtBQUtnRCxhQUFMLENBQW1CaEQsR0FBbkIsQ0FBUDtBQUNELEtBUkg7QUFXQSxTQUFLMEUsS0FBTCxDQUNFLEtBREYsRUFFRSx5QkFGRixFQUdFMUUsR0FBRyxJQUFJO0FBQ0wsV0FBS21FLFNBQUwsQ0FBZW5FLEdBQWY7QUFDRCxLQUxILEVBTUVBLEdBQUcsSUFBSTtBQUNMLGFBQU8sS0FBS3lDLG9CQUFMLENBQTBCekMsR0FBMUIsQ0FBUDtBQUNELEtBUkg7QUFVRDs7QUFFRDJFLEVBQUFBLGFBQWEsR0FBRztBQUNkLFVBQU1DLE1BQU0sR0FBR0MsaUJBQVFDLE1BQVIsRUFBZjs7QUFDQUYsSUFBQUEsTUFBTSxDQUFDRyxHQUFQLENBQVcsT0FBWCxFQUFvQkYsaUJBQVFHLE1BQVIsQ0FBZXhGLFdBQWYsQ0FBcEI7QUFDQW9GLElBQUFBLE1BQU0sQ0FBQ0csR0FBUCxDQUFXLEdBQVgsRUFBZ0IsTUFBTUosYUFBTixFQUFoQjtBQUNBLFdBQU9DLE1BQVA7QUFDRDs7QUF0WGdEOzs7ZUF5WHBDL0UsZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBQcm9taXNlUm91dGVyIGZyb20gJy4uL1Byb21pc2VSb3V0ZXInO1xuaW1wb3J0IENvbmZpZyBmcm9tICcuLi9Db25maWcnO1xuaW1wb3J0IGV4cHJlc3MgZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgcXMgZnJvbSAncXVlcnlzdHJpbmcnO1xuaW1wb3J0IHsgUGFyc2UgfSBmcm9tICdwYXJzZS9ub2RlJztcblxuY29uc3QgcHVibGljX2h0bWwgPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4vLi4vcHVibGljX2h0bWwnKTtcbmNvbnN0IHZpZXdzID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uLy4uL3ZpZXdzJyk7XG5cbmV4cG9ydCBjbGFzcyBQdWJsaWNBUElSb3V0ZXIgZXh0ZW5kcyBQcm9taXNlUm91dGVyIHtcbiAgdmVyaWZ5RW1haWwocmVxKSB7XG4gICAgY29uc3QgeyB0b2tlbiwgdXNlcm5hbWUsIG1haWwgfSA9IHJlcS5xdWVyeTtcbiAgICBjb25zdCBhcHBJZCA9IHByb2Nlc3MuZW52LkFQUF9JRCB8fCAnVGlja2V0RnVjaHMnO1xuICAgIGNvbnNvbGUubG9nKGBBcHBJRDogJHthcHBJZH1gKTtcbiAgICBjb25zdCBjb25maWcgPSBDb25maWcuZ2V0KGFwcElkKTtcblxuICAgIGlmICghY29uZmlnKSB7XG4gICAgICBjb25zb2xlLmxvZygnUHVibGljQXBpUm91dGVyLmpzIEwuIDE4Jyk7XG4gICAgICB0aGlzLmludmFsaWRSZXF1ZXN0KCk7XG4gICAgfVxuXG4gICAgaWYgKCFjb25maWcucHVibGljU2VydmVyVVJMKSB7XG4gICAgICByZXR1cm4gdGhpcy5taXNzaW5nUHVibGljU2VydmVyVVJMKCk7XG4gICAgfVxuXG4gICAgaWYgKCF0b2tlbiB8fCAhdXNlcm5hbWUgfHwgIW1haWwpIHtcbiAgICAgIGNvbnNvbGUubG9nKGBNYWlsYWRyZXNzZTogJHttYWlsfWApO1xuICAgICAgY29uc29sZS5sb2coJ1B1YmxpY0FwaVJvdXRlci5qcyBMLiAyOCcpO1xuICAgICAgcmV0dXJuIHRoaXMuaW52YWxpZExpbmsocmVxKTtcbiAgICB9XG5cbiAgICBjb25zdCB1c2VyQ29udHJvbGxlciA9IGNvbmZpZy51c2VyQ29udHJvbGxlcjtcbiAgICByZXR1cm4gdXNlckNvbnRyb2xsZXIudmVyaWZ5RW1haWwodXNlcm5hbWUsIHRva2VuKS50aGVuKFxuICAgICAgKCkgPT4ge1xuICAgICAgICBjb25zdCBwYXJhbXMgPSBxcy5zdHJpbmdpZnkoeyBtYWlsIH0pO1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHtcbiAgICAgICAgICBzdGF0dXM6IDMwMixcbiAgICAgICAgICBsb2NhdGlvbjogYCR7Y29uZmlnLnZlcmlmeUVtYWlsU3VjY2Vzc1VSTH0/JHtwYXJhbXN9YCxcbiAgICAgICAgfSk7XG4gICAgICB9LFxuICAgICAgKCkgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5pbnZhbGlkVmVyaWZpY2F0aW9uTGluayhyZXEpO1xuICAgICAgfVxuICAgICk7XG4gIH1cblxuICByZXNlbmRWZXJpZmljYXRpb25FbWFpbChyZXEpIHtcbiAgICBjb25zb2xlLmxvZygnUmVxdWVzdCcgKyBKU09OLnN0cmluZ2lmeShyZXEuYm9keSkpO1xuICAgIGNvbnN0IHVzZXJuYW1lID0gcmVxLmJvZHkudXNlcm5hbWU7XG4gICAgY29uc3QgYXBwSWQgPSBwcm9jZXNzLmVudi5BUFBfSUQgfHwgJ1RpY2tldEZ1Y2hzJztcbiAgICBjb25zb2xlLmxvZyhgQXBwSUQ6ICR7YXBwSWR9YCk7XG5cbiAgICBjb25zdCBjb25maWcgPSBDb25maWcuZ2V0KGFwcElkKTtcblxuICAgIGlmICghY29uZmlnKSB7XG4gICAgICBjb25zb2xlLmxvZygnUHVibGljQXBpUm91dGVyLmpzIEwuIDUxJyk7XG4gICAgICB0aGlzLmludmFsaWRSZXF1ZXN0KCk7XG4gICAgfVxuXG4gICAgaWYgKCFjb25maWcucHVibGljU2VydmVyVVJMKSB7XG4gICAgICByZXR1cm4gdGhpcy5taXNzaW5nUHVibGljU2VydmVyVVJMKCk7XG4gICAgfVxuXG4gICAgaWYgKCF1c2VybmFtZSkge1xuICAgICAgY29uc29sZS5sb2coJ1VzZXJuYW1lOicgKyB1c2VybmFtZSk7XG4gICAgICBjb25zb2xlLmxvZygnUHVibGljQXBpUm91dGVyLmpzIEwuIDY4Jyk7XG4gICAgICByZXR1cm4gdGhpcy5pbnZhbGlkTGluayhyZXEpO1xuICAgIH1cblxuICAgIGNvbnN0IHVzZXJDb250cm9sbGVyID0gY29uZmlnLnVzZXJDb250cm9sbGVyO1xuXG4gICAgcmV0dXJuIHVzZXJDb250cm9sbGVyLnJlc2VuZFZlcmlmaWNhdGlvbkVtYWlsKHVzZXJuYW1lKS50aGVuKFxuICAgICAgKCkgPT4ge1xuICAgICAgICBjb25zdCBwYXJhbXMgPSBxcy5zdHJpbmdpZnkoeyB1c2VybmFtZSB9KTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7XG4gICAgICAgICAgc3RhdHVzOiAzMDIsXG4gICAgICAgICAgbG9jYXRpb246IGAke2NvbmZpZy5saW5rU2VuZFN1Y2Nlc3NVUkx9PyR7cGFyYW1zfWAsXG4gICAgICAgIH0pO1xuICAgICAgfSxcbiAgICAgICgpID0+IHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7XG4gICAgICAgICAgc3RhdHVzOiAzMDIsXG4gICAgICAgICAgbG9jYXRpb246IGAke2NvbmZpZy5saW5rU2VuZEZhaWxVUkx9YCxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIGNoYW5nZVBhc3N3b3JkKHJlcSkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCBhcHBJZCA9IHByb2Nlc3MuZW52LkFQUF9JRCB8fCAnVGlja2V0RnVjaHMnO1xuICAgICAgY29uc3QgY29uZmlnID0gQ29uZmlnLmdldChhcHBJZCk7XG5cbiAgICAgIGlmICghY29uZmlnKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdQdWJsaWNBcGlSb3V0ZXIuanMgTC4gOTUnKTtcbiAgICAgICAgdGhpcy5pbnZhbGlkUmVxdWVzdCgpO1xuICAgICAgfVxuXG4gICAgICBpZiAoIWNvbmZpZy5wdWJsaWNTZXJ2ZXJVUkwpIHtcbiAgICAgICAgcmV0dXJuIHJlc29sdmUoe1xuICAgICAgICAgIHN0YXR1czogNDA0LFxuICAgICAgICAgIHRleHQ6ICdOb3QgZm91bmQuJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICAvLyBTaG91bGQgd2Uga2VlcCB0aGUgZmlsZSBpbiBtZW1vcnkgb3IgbGVhdmUgbGlrZSB0aGF0P1xuICAgICAgZnMucmVhZEZpbGUoXG4gICAgICAgIHBhdGgucmVzb2x2ZSh2aWV3cywgJ2Nob29zZV9wYXNzd29yZCcpLFxuICAgICAgICAndXRmLTgnLFxuICAgICAgICAoZXJyLCBkYXRhKSA9PiB7XG4gICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgcmV0dXJuIHJlamVjdChlcnIpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBkYXRhID0gZGF0YS5yZXBsYWNlKFxuICAgICAgICAgICAgJ1BBUlNFX1NFUlZFUl9VUkwnLFxuICAgICAgICAgICAgYCcke2NvbmZpZy5wdWJsaWNTZXJ2ZXJVUkx9J2BcbiAgICAgICAgICApO1xuICAgICAgICAgIHJlc29sdmUoe1xuICAgICAgICAgICAgdGV4dDogZGF0YSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIHJlcXVlc3RSZXNldFBhc3N3b3JkKHJlcSkge1xuICAgIGNvbnN0IGFwcElkID0gcHJvY2Vzcy5lbnYuQVBQX0lEIHx8ICdUaWNrZXRGdWNocyc7XG4gICAgY29uc29sZS5sb2coYEFwcElEOiAke2FwcElkfWApO1xuICAgIGNvbnN0IGNvbmZpZyA9IENvbmZpZy5nZXQoYXBwSWQpO1xuXG4gICAgaWYgKCFjb25maWcpIHtcbiAgICAgIGNvbnNvbGUubG9nKCdQdWJsaWNBcGlSb3V0ZXIuanMgTC4gMTIwJyk7XG4gICAgICB0aGlzLmludmFsaWRSZXF1ZXN0KCk7XG4gICAgfVxuXG4gICAgaWYgKCFjb25maWcucHVibGljU2VydmVyVVJMKSB7XG4gICAgICByZXR1cm4gdGhpcy5taXNzaW5nUHVibGljU2VydmVyVVJMKCk7XG4gICAgfVxuXG4gICAgY29uc3QgeyB1c2VybmFtZSwgdG9rZW4sIG1haWwgfSA9IHJlcS5xdWVyeTtcblxuICAgIGlmICghdXNlcm5hbWUgfHwgIXRva2VuIHx8ICFtYWlsKSB7XG4gICAgICBjb25zb2xlLmxvZyhgTWFpbGFkcmVzc2U6ICR7bWFpbH1gKTtcbiAgICAgIGNvbnNvbGUubG9nKCdQdWJsaWNBcGlSb3V0ZXIuanMgTC4gMjgnKTtcbiAgICAgIHJldHVybiB0aGlzLmludmFsaWRMaW5rKHJlcSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNvbmZpZy51c2VyQ29udHJvbGxlci5jaGVja1Jlc2V0VG9rZW5WYWxpZGl0eSh1c2VybmFtZSwgdG9rZW4pLnRoZW4oXG4gICAgICAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHBhcmFtcyA9IHFzLnN0cmluZ2lmeSh7XG4gICAgICAgICAgdG9rZW4sXG4gICAgICAgICAgbWFpbDogbWFpbCxcbiAgICAgICAgICBpZDogY29uZmlnLmFwcGxpY2F0aW9uSWQsXG4gICAgICAgICAgdXNlcm5hbWUsXG4gICAgICAgICAgYXBwOiBjb25maWcuYXBwTmFtZSxcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe1xuICAgICAgICAgIHN0YXR1czogMzAyLFxuICAgICAgICAgIGxvY2F0aW9uOiBgJHtjb25maWcuY2hvb3NlUGFzc3dvcmRVUkx9PyR7cGFyYW1zfWAsXG4gICAgICAgIH0pO1xuICAgICAgfSxcbiAgICAgICgpID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaW52YWxpZExpbmsocmVxKTtcbiAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgcmVzZXRQYXNzd29yZChyZXEpIHtcbiAgICBjb25zdCBhcHBJZCA9IHByb2Nlc3MuZW52LkFQUF9JRCB8fCAnVGlja2V0RnVjaHMnO1xuICAgIGNvbnNvbGUubG9nKGBBcHBJRDogJHthcHBJZH1gKTtcbiAgICBjb25zdCBjb25maWcgPSBDb25maWcuZ2V0KGFwcElkKTtcblxuICAgIGlmICghY29uZmlnKSB7XG4gICAgICBjb25zb2xlLmxvZygnUHVibGljQXBpUm91dGVyLmpzIEwuIDE1NycpO1xuICAgICAgdGhpcy5pbnZhbGlkUmVxdWVzdCgpO1xuICAgIH1cblxuICAgIGlmICghY29uZmlnLnB1YmxpY1NlcnZlclVSTCkge1xuICAgICAgcmV0dXJuIHRoaXMubWlzc2luZ1B1YmxpY1NlcnZlclVSTCgpO1xuICAgIH1cblxuICAgIGNvbnN0IHsgdXNlcm5hbWUsIHRva2VuLCBuZXdfcGFzc3dvcmQsIG1haWwgfSA9IHJlcS5ib2R5O1xuXG4gICAgaWYgKCghdXNlcm5hbWUgfHwgIXRva2VuIHx8ICFuZXdfcGFzc3dvcmQgfHwgIW1haWwpICYmIHJlcS54aHIgPT09IGZhbHNlKSB7XG4gICAgICBjb25zb2xlLmxvZygnUHVibGljQXBpUm91dGVyLmpzIEwuIDE4NScpO1xuICAgICAgcmV0dXJuIHRoaXMuaW52YWxpZExpbmsocmVxKTtcbiAgICB9XG5cbiAgICBpZiAoIXVzZXJuYW1lKSB7XG4gICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoUGFyc2UuRXJyb3IuVVNFUk5BTUVfTUlTU0lORywgJ01pc3NpbmcgdXNlcm5hbWUnKTtcbiAgICB9XG5cbiAgICBpZiAoIXRva2VuKSB7XG4gICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoUGFyc2UuRXJyb3IuT1RIRVJfQ0FVU0UsICdNaXNzaW5nIHRva2VuJyk7XG4gICAgfVxuXG4gICAgaWYgKCFuZXdfcGFzc3dvcmQpIHtcbiAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihQYXJzZS5FcnJvci5QQVNTV09SRF9NSVNTSU5HLCAnTWlzc2luZyBwYXNzd29yZCcpO1xuICAgIH1cblxuICAgIGlmICghbWFpbCkge1xuICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLkVNQUlMX01JU1NJTkcsICdNaXNzaW5nIE1haWwnKTtcbiAgICB9XG5cbiAgICByZXR1cm4gY29uZmlnLnVzZXJDb250cm9sbGVyXG4gICAgICAudXBkYXRlUGFzc3dvcmQodXNlcm5hbWUsIHRva2VuLCBuZXdfcGFzc3dvcmQpXG4gICAgICAudGhlbihcbiAgICAgICAgKCkgPT4ge1xuICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe1xuICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSxcbiAgICAgICAgZXJyID0+IHtcbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgICAgZXJyLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICApXG4gICAgICAudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICBjb25zdCBwYXJhbXMgPSBxcy5zdHJpbmdpZnkoe1xuICAgICAgICAgIHVzZXJuYW1lOiB1c2VybmFtZSxcbiAgICAgICAgICB0b2tlbjogdG9rZW4sXG4gICAgICAgICAgaWQ6IGNvbmZpZy5hcHBsaWNhdGlvbklkLFxuICAgICAgICAgIGVycm9yOiByZXN1bHQuZXJyLFxuICAgICAgICAgIGFwcDogY29uZmlnLmFwcE5hbWUsXG4gICAgICAgICAgbWFpbDogbWFpbCxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKHJlcS54aHIpIHtcbiAgICAgICAgICBpZiAocmVzdWx0LnN1Y2Nlc3MpIHtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe1xuICAgICAgICAgICAgICBzdGF0dXM6IDIwMCxcbiAgICAgICAgICAgICAgcmVzcG9uc2U6ICdQYXNzd29yZCBzdWNjZXNzZnVsbHkgcmVzZXQnLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChyZXN1bHQuZXJyKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoUGFyc2UuRXJyb3IuT1RIRVJfQ0FVU0UsIGAke3Jlc3VsdC5lcnJ9YCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7XG4gICAgICAgICAgc3RhdHVzOiAzMDIsXG4gICAgICAgICAgbG9jYXRpb246IGAke1xuICAgICAgICAgICAgcmVzdWx0LnN1Y2Nlc3NcbiAgICAgICAgICAgICAgPyBgJHtjb25maWcucGFzc3dvcmRSZXNldFN1Y2Nlc3NVUkx9P21haWw9JHttYWlsfWBcbiAgICAgICAgICAgICAgOiBgJHtjb25maWcuY2hvb3NlUGFzc3dvcmRVUkx9PyR7cGFyYW1zfWBcbiAgICAgICAgICB9YCxcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgfVxuXG4gIGludmFsaWRMaW5rKHJlcSkge1xuICAgIHZhciBjb25maWcgPSBudWxsO1xuICAgIGNvbnNvbGUubG9nKCdQdWJsaWNBcGlSb3V0ZXIuanMgTC4gMjE1Jyk7XG4gICAgY29uc29sZS5sb2coYHJlcTogJHtyZXF9YCk7XG4gICAgaWYgKHJlcSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBjb25zdCBhcHBJZCA9IHByb2Nlc3MuZW52LkFQUF9JRCB8fCAnVGlja2V0RnVjaHMnO1xuICAgICAgY29uc29sZS5sb2coYEFwcElEOiAke2FwcElkfWApO1xuICAgICAgY29uZmlnID0gQ29uZmlnLmdldChhcHBJZCk7XG4gICAgICBjb25zb2xlLmxvZyhgY29uZmlnOiAke2NvbmZpZ31gKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uZmlnID0gcmVxLmNvbmZpZztcbiAgICAgIGNvbnNvbGUubG9nKGBjb25maWc6ICR7Y29uZmlnfWApO1xuICAgIH1cbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHtcbiAgICAgIHN0YXR1czogMzAyLFxuICAgICAgbG9jYXRpb246IGNvbmZpZy5pbnZhbGlkTGlua1VSTCxcbiAgICB9KTtcbiAgfVxuXG4gIGludmFsaWRWZXJpZmljYXRpb25MaW5rKHJlcSkge1xuICAgIHZhciBjb25maWcgPSByZXEuY29uZmlnO1xuICAgIGNvbnNvbGUubG9nKCdQdWJsaWNBcGlSb3V0ZXIuanMgTC4gMjM1Jyk7XG4gICAgY29uc29sZS5sb2coYHJlcTogJHtyZXF9YCk7XG4gICAgaWYgKGNvbmZpZyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBjb25zdCBhcHBJZCA9IHByb2Nlc3MuZW52LkFQUF9JRCB8fCAnVGlja2V0RnVjaHMnO1xuICAgICAgY29uc29sZS5sb2coYEFwcElEOiAke2FwcElkfWApO1xuICAgICAgY29uZmlnID0gQ29uZmlnLmdldChhcHBJZCk7XG4gICAgICBjb25zb2xlLmxvZyhgY29uZmlnOiAke2NvbmZpZ31gKTtcbiAgICB9XG4gICAgY29uc29sZS5sb2coYGNvbmZpZzogJHtjb25maWd9YCk7XG4gICAgaWYgKHJlcS5xdWVyeS51c2VybmFtZSkge1xuICAgICAgY29uc3QgcGFyYW1zID0gcXMuc3RyaW5naWZ5KHtcbiAgICAgICAgdXNlcm5hbWU6IHJlcS5xdWVyeS51c2VybmFtZSxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7XG4gICAgICAgIHN0YXR1czogMzAyLFxuICAgICAgICBsb2NhdGlvbjogYCR7Y29uZmlnLmludmFsaWRWZXJpZmljYXRpb25MaW5rVVJMfT8ke3BhcmFtc31gLFxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUubG9nKCdQdWJsaWNBcGlSb3V0ZXIuanMgTC4gMjUzJyk7XG4gICAgICByZXR1cm4gdGhpcy5pbnZhbGlkTGluayhyZXEpO1xuICAgIH1cbiAgfVxuXG4gIG1pc3NpbmdQdWJsaWNTZXJ2ZXJVUkwoKSB7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7XG4gICAgICB0ZXh0OiAnTm90IGZvdW5kLicsXG4gICAgICBzdGF0dXM6IDQwNCxcbiAgICB9KTtcbiAgfVxuXG4gIGludmFsaWRSZXF1ZXN0KCkge1xuICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKCk7XG4gICAgZXJyb3Iuc3RhdHVzID0gNDAzO1xuICAgIGVycm9yLm1lc3NhZ2UgPSAndW5hdXRob3JpemVkJztcbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxuXG4gIHNldENvbmZpZyhyZXEpIHtcbiAgICB2YXIgc2VlbiA9IFtdO1xuICAgIGNvbnNvbGUubG9nKFxuICAgICAgSlNPTi5zdHJpbmdpZnkocmVxLCBmdW5jdGlvbihrZXksIHZhbCkge1xuICAgICAgICBpZiAodmFsICE9IG51bGwgJiYgdHlwZW9mIHZhbCA9PSAnb2JqZWN0Jykge1xuICAgICAgICAgIGlmIChzZWVuLmluZGV4T2YodmFsKSA+PSAwKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuICAgICAgICAgIHNlZW4ucHVzaCh2YWwpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB2YWw7XG4gICAgICB9KVxuICAgICk7XG5cbiAgICBjb25zdCBhcHBJZCA9IHByb2Nlc3MuZW52LkFQUF9JRCB8fCAnVGlja2V0RnVjaHMnO1xuICAgIHJlcS5jb25maWcgPSBDb25maWcuZ2V0KGFwcElkKTtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gIH1cblxuICBtb3VudFJvdXRlcygpIHtcbiAgICB0aGlzLnJvdXRlKFxuICAgICAgJ0dFVCcsXG4gICAgICAnL3ZlcmlmeV9lbWFpbCcsXG4gICAgICByZXEgPT4ge1xuICAgICAgICB0aGlzLnNldENvbmZpZyhyZXEpO1xuICAgICAgfSxcbiAgICAgIHJlcSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLnZlcmlmeUVtYWlsKHJlcSk7XG4gICAgICB9XG4gICAgKTtcblxuICAgIHRoaXMucm91dGUoXG4gICAgICAnUE9TVCcsXG4gICAgICAnL3Jlc2VuZF92ZXJpZmljYXRpb25fZW1haWwnLFxuICAgICAgcmVxID0+IHtcbiAgICAgICAgdGhpcy5zZXRDb25maWcocmVxKTtcbiAgICAgIH0sXG4gICAgICByZXEgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5yZXNlbmRWZXJpZmljYXRpb25FbWFpbChyZXEpO1xuICAgICAgfVxuICAgICk7XG5cbiAgICB0aGlzLnJvdXRlKCdHRVQnLCAnL2Nob29zZV9wYXNzd29yZCcsIHJlcSA9PiB7XG4gICAgICByZXR1cm4gdGhpcy5jaGFuZ2VQYXNzd29yZChyZXEpO1xuICAgIH0pO1xuXG4gICAgdGhpcy5yb3V0ZShcbiAgICAgICdQT1NUJyxcbiAgICAgICcvcmVxdWVzdF9wYXNzd29yZF9yZXNldCcsXG4gICAgICByZXEgPT4ge1xuICAgICAgICB0aGlzLnNldENvbmZpZyhyZXEpO1xuICAgICAgfSxcbiAgICAgIHJlcSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLnJlc2V0UGFzc3dvcmQocmVxKTtcbiAgICAgIH1cbiAgICApO1xuXG4gICAgdGhpcy5yb3V0ZShcbiAgICAgICdHRVQnLFxuICAgICAgJy9yZXF1ZXN0X3Bhc3N3b3JkX3Jlc2V0JyxcbiAgICAgIHJlcSA9PiB7XG4gICAgICAgIHRoaXMuc2V0Q29uZmlnKHJlcSk7XG4gICAgICB9LFxuICAgICAgcmVxID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMucmVxdWVzdFJlc2V0UGFzc3dvcmQocmVxKTtcbiAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgZXhwcmVzc1JvdXRlcigpIHtcbiAgICBjb25zdCByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xuICAgIHJvdXRlci51c2UoJy9hcHBzJywgZXhwcmVzcy5zdGF0aWMocHVibGljX2h0bWwpKTtcbiAgICByb3V0ZXIudXNlKCcvJywgc3VwZXIuZXhwcmVzc1JvdXRlcigpKTtcbiAgICByZXR1cm4gcm91dGVyO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFB1YmxpY0FQSVJvdXRlcjtcbiJdfQ==