"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.PublicAPIRouter = void 0;

var _PromiseRouter = _interopRequireDefault(require("../PromiseRouter"));

var _Config = _interopRequireDefault(require("../Config"));

var _express = _interopRequireDefault(require("express"));

var _path = _interopRequireDefault(require("path"));

var _fs = _interopRequireDefault(require("fs"));

var _querystring = _interopRequireDefault(require("querystring"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const public_html = _path.default.resolve(__dirname, '../../public_html');

const views = _path.default.resolve(__dirname, '../../views');

class PublicAPIRouter extends _PromiseRouter.default {
  verifyEmail(req) {
    const {
      token,
      username,
      mail
    } = req.query;
    const appId = process.env.APP_ID || 'TicketFuchs';
    console.log(`AppID: ${appId}`);

    const config = _Config.default.get(appId);

    if (!config) {
      console.log("PublicApiRouter.js L. 18");
      this.invalidRequest();
    }

    if (!config.publicServerURL) {
      return this.missingPublicServerURL();
    }

    if (!token || !username || !mail) {
      console.log(`Mailadresse: ${mail}`);
      console.log("PublicApiRouter.js L. 28");
      return this.invalidLink(req);
    }

    const userController = config.userController;
    return userController.verifyEmail(username, token).then(() => {
      const params = _querystring.default.stringify({
        mail
      });

      return Promise.resolve({
        status: 302,
        location: `${config.verifyEmailSuccessURL}?${params}`
      });
    }, () => {
      return this.invalidVerificationLink(req);
    });
  }

  resendVerificationEmail(req) {
    console.log("Request" + JSON.stringify(req.body));
    const username = req.body.username;
    const appId = process.env.APP_ID || 'TicketFuchs';
    console.log(`AppID: ${appId}`);

    const config = _Config.default.get(appId);

    if (!config) {
      console.log("PublicApiRouter.js L. 51");
      this.invalidRequest();
    }

    if (!config.publicServerURL) {
      return this.missingPublicServerURL();
    }

    if (!username) {
      console.log("Username:" + username);
      console.log("PublicApiRouter.js L. 68");
      return this.invalidLink(req);
    }

    const userController = config.userController;
    return userController.resendVerificationEmail(username).then(() => {
      const params = _querystring.default.stringify({
        username
      });

      return Promise.resolve({
        status: 302,
        location: `${config.linkSendSuccessURL}?${params}`
      });
    }, () => {
      return Promise.resolve({
        status: 302,
        location: `${config.linkSendFailURL}`
      });
    });
  }

  changePassword(req) {
    return new Promise((resolve, reject) => {
      const appId = process.env.APP_ID || 'TicketFuchs';

      const config = _Config.default.get(appId);

      if (!config) {
        console.log("PublicApiRouter.js L. 95");
        this.invalidRequest();
      }

      if (!config.publicServerURL) {
        return resolve({
          status: 404,
          text: 'Not found.'
        });
      } // Should we keep the file in memory or leave like that?


      _fs.default.readFile(_path.default.resolve(views, 'choose_password'), 'utf-8', (err, data) => {
        if (err) {
          return reject(err);
        }

        data = data.replace('PARSE_SERVER_URL', `'${config.publicServerURL}'`);
        resolve({
          text: data
        });
      });
    });
  }

  requestResetPassword(req) {
    const appId = process.env.APP_ID || 'TicketFuchs';
    console.log(`AppID: ${appId}`);

    const config = _Config.default.get(appId);

    if (!config) {
      console.log("PublicApiRouter.js L. 120");
      this.invalidRequest();
    }

    if (!config.publicServerURL) {
      return this.missingPublicServerURL();
    }

    const {
      username,
      token,
      mail
    } = req.query;

    if (!username || !token || !mail) {
      console.log(`Mailadresse: ${mail}`);
      console.log("PublicApiRouter.js L. 28");
      return this.invalidLink(req);
    }

    return config.userController.checkResetTokenValidity(username, token).then(() => {
      const params = _querystring.default.stringify({
        token,
        mail: mail,
        username
      });

      return Promise.resolve({
        status: 302,
        location: `${config.choosePasswordURL}?${params}`
      });
    }, () => {
      return this.invalidLink(req);
    });
  }

  resetPassword(req) {
    const appId = process.env.APP_ID || 'TicketFuchs';
    console.log(`AppID: ${appId}`);

    const config = _Config.default.get(appId);

    if (!config) {
      console.log("PublicApiRouter.js L. 157");
      this.invalidRequest();
    }

    if (!config.publicServerURL) {
      return this.missingPublicServerURL();
    }

    const {
      username,
      token,
      new_password,
      mail
    } = req.body;

    if (!username || !token || !new_password || !mail) {
      console.log("PublicApiRouter.js L. 185");
      return this.invalidLink(req);
    }

    return config.userController.updatePassword(username, token, new_password).then(() => {
      const params = _querystring.default.stringify({
        mail: mail
      });

      return Promise.resolve({
        status: 302,
        location: `${config.passwordResetSuccessURL}?${params}`
      });
    }, err => {
      const params = _querystring.default.stringify({
        username: username,
        token: token,
        id: config.applicationId,
        error: err,
        mail: mail
      });

      return Promise.resolve({
        status: 302,
        location: `${config.choosePasswordURL}?${params}`
      });
    });
  }

  invalidLink(req) {
    var config = null;
    console.log("PublicApiRouter.js L. 215");
    console.log(`req: ${req}`);

    if (req === undefined) {
      const appId = process.env.APP_ID || 'TicketFuchs';
      console.log(`AppID: ${appId}`);
      config = _Config.default.get(appId);
      console.log(`config: ${config}`);
    } else {
      config = req.config;
      console.log(`config: ${config}`);
    }

    return Promise.resolve({
      status: 302,
      location: config.invalidLinkURL
    });
  }

  invalidVerificationLink(req) {
    var config = req.config;
    console.log("PublicApiRouter.js L. 235");
    console.log(`req: ${req}`);

    if (config === undefined) {
      const appId = process.env.APP_ID || 'TicketFuchs';
      console.log(`AppID: ${appId}`);
      config = _Config.default.get(appId);
      console.log(`config: ${config}`);
    }

    console.log(`config: ${config}`);

    if (req.query.username) {
      const params = _querystring.default.stringify({
        username: req.query.username
      });

      return Promise.resolve({
        status: 302,
        location: `${config.invalidVerificationLinkURL}?${params}`
      });
    } else {
      console.log("PublicApiRouter.js L. 253");
      return this.invalidLink(req);
    }
  }

  missingPublicServerURL() {
    return Promise.resolve({
      text: 'Not found.',
      status: 404
    });
  }

  invalidRequest() {
    const error = new Error();
    error.status = 403;
    error.message = 'unauthorized';
    throw error;
  }

  setConfig(req) {
    var seen = [];
    console.log(JSON.stringify(req, function (key, val) {
      if (val != null && typeof val == "object") {
        if (seen.indexOf(val) >= 0) {
          return;
        }

        seen.push(val);
      }

      return val;
    }));
    const appId = process.env.APP_ID || 'TicketFuchs';
    req.config = _Config.default.get(appId);
    return Promise.resolve();
  }

  mountRoutes() {
    this.route('GET', '/verify_email', req => {
      this.setConfig(req);
    }, req => {
      return this.verifyEmail(req);
    });
    this.route('POST', '/resend_verification_email', req => {
      this.setConfig(req);
    }, req => {
      return this.resendVerificationEmail(req);
    });
    this.route('GET', '/choose_password', req => {
      return this.changePassword(req);
    });
    this.route('POST', '/request_password_reset', req => {
      this.setConfig(req);
    }, req => {
      return this.resetPassword(req);
    });
    this.route('GET', '/request_password_reset', req => {
      this.setConfig(req);
    }, req => {
      return this.requestResetPassword(req);
    });
  }

  expressRouter() {
    const router = _express.default.Router();

    router.use('/apps', _express.default.static(public_html));
    router.use('/', super.expressRouter());
    return router;
  }

}

exports.PublicAPIRouter = PublicAPIRouter;
var _default = PublicAPIRouter;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Sb3V0ZXJzL1B1YmxpY0FQSVJvdXRlci5qcyJdLCJuYW1lcyI6WyJwdWJsaWNfaHRtbCIsInBhdGgiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwidmlld3MiLCJQdWJsaWNBUElSb3V0ZXIiLCJQcm9taXNlUm91dGVyIiwidmVyaWZ5RW1haWwiLCJyZXEiLCJ0b2tlbiIsInVzZXJuYW1lIiwibWFpbCIsInF1ZXJ5IiwiYXBwSWQiLCJwcm9jZXNzIiwiZW52IiwiQVBQX0lEIiwiY29uc29sZSIsImxvZyIsImNvbmZpZyIsIkNvbmZpZyIsImdldCIsImludmFsaWRSZXF1ZXN0IiwicHVibGljU2VydmVyVVJMIiwibWlzc2luZ1B1YmxpY1NlcnZlclVSTCIsImludmFsaWRMaW5rIiwidXNlckNvbnRyb2xsZXIiLCJ0aGVuIiwicGFyYW1zIiwicXMiLCJzdHJpbmdpZnkiLCJQcm9taXNlIiwic3RhdHVzIiwibG9jYXRpb24iLCJ2ZXJpZnlFbWFpbFN1Y2Nlc3NVUkwiLCJpbnZhbGlkVmVyaWZpY2F0aW9uTGluayIsInJlc2VuZFZlcmlmaWNhdGlvbkVtYWlsIiwiSlNPTiIsImJvZHkiLCJsaW5rU2VuZFN1Y2Nlc3NVUkwiLCJsaW5rU2VuZEZhaWxVUkwiLCJjaGFuZ2VQYXNzd29yZCIsInJlamVjdCIsInRleHQiLCJmcyIsInJlYWRGaWxlIiwiZXJyIiwiZGF0YSIsInJlcGxhY2UiLCJyZXF1ZXN0UmVzZXRQYXNzd29yZCIsImNoZWNrUmVzZXRUb2tlblZhbGlkaXR5IiwiY2hvb3NlUGFzc3dvcmRVUkwiLCJyZXNldFBhc3N3b3JkIiwibmV3X3Bhc3N3b3JkIiwidXBkYXRlUGFzc3dvcmQiLCJwYXNzd29yZFJlc2V0U3VjY2Vzc1VSTCIsImlkIiwiYXBwbGljYXRpb25JZCIsImVycm9yIiwidW5kZWZpbmVkIiwiaW52YWxpZExpbmtVUkwiLCJpbnZhbGlkVmVyaWZpY2F0aW9uTGlua1VSTCIsIkVycm9yIiwibWVzc2FnZSIsInNldENvbmZpZyIsInNlZW4iLCJrZXkiLCJ2YWwiLCJpbmRleE9mIiwicHVzaCIsIm1vdW50Um91dGVzIiwicm91dGUiLCJleHByZXNzUm91dGVyIiwicm91dGVyIiwiZXhwcmVzcyIsIlJvdXRlciIsInVzZSIsInN0YXRpYyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBRUEsTUFBTUEsV0FBVyxHQUFHQyxjQUFLQyxPQUFMLENBQWFDLFNBQWIsRUFBd0IsbUJBQXhCLENBQXBCOztBQUNBLE1BQU1DLEtBQUssR0FBR0gsY0FBS0MsT0FBTCxDQUFhQyxTQUFiLEVBQXdCLGFBQXhCLENBQWQ7O0FBRU8sTUFBTUUsZUFBTixTQUE4QkMsc0JBQTlCLENBQTRDO0FBQ2pEQyxFQUFBQSxXQUFXLENBQUNDLEdBQUQsRUFBTTtBQUNmLFVBQU07QUFBRUMsTUFBQUEsS0FBRjtBQUFTQyxNQUFBQSxRQUFUO0FBQW1CQyxNQUFBQTtBQUFuQixRQUE0QkgsR0FBRyxDQUFDSSxLQUF0QztBQUNBLFVBQU1DLEtBQUssR0FBR0MsT0FBTyxDQUFDQyxHQUFSLENBQVlDLE1BQVosSUFBc0IsYUFBcEM7QUFDQUMsSUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQWEsVUFBU0wsS0FBTSxFQUE1Qjs7QUFDQSxVQUFNTSxNQUFNLEdBQUdDLGdCQUFPQyxHQUFQLENBQVdSLEtBQVgsQ0FBZjs7QUFFQSxRQUFJLENBQUNNLE1BQUwsRUFBYTtBQUNYRixNQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSwwQkFBWjtBQUNBLFdBQUtJLGNBQUw7QUFDRDs7QUFFRCxRQUFJLENBQUNILE1BQU0sQ0FBQ0ksZUFBWixFQUE2QjtBQUMzQixhQUFPLEtBQUtDLHNCQUFMLEVBQVA7QUFDRDs7QUFFRCxRQUFJLENBQUNmLEtBQUQsSUFBVSxDQUFDQyxRQUFYLElBQXNCLENBQUNDLElBQTNCLEVBQWlDO0FBQy9CTSxNQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBYSxnQkFBZVAsSUFBSyxFQUFqQztBQUNBTSxN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QXlFLElBQUFBLE1BQU0sQ0FBQ0csR0FBUCxDQUFXLEdBQVgsRUFBZ0IsTUFBTUosYUFBTixFQUFoQjtBQUNBLFdBQU9DLE1BQVA7QUFDRDs7QUFwVmdEOzs7ZUF1VnBDcEUsZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBQcm9taXNlUm91dGVyIGZyb20gJy4uL1Byb21pc2VSb3V0ZXInO1xuaW1wb3J0IENvbmZpZyBmcm9tICcuLi9Db25maWcnO1xuaW1wb3J0IGV4cHJlc3MgZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgcXMgZnJvbSAncXVlcnlzdHJpbmcnO1xuXG5jb25zdCBwdWJsaWNfaHRtbCA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLi8uLi9wdWJsaWNfaHRtbCcpO1xuY29uc3Qgdmlld3MgPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4vLi4vdmlld3MnKTtcblxuZXhwb3J0IGNsYXNzIFB1YmxpY0FQSVJvdXRlciBleHRlbmRzIFByb21pc2VSb3V0ZXIge1xuICB2ZXJpZnlFbWFpbChyZXEpIHtcbiAgICBjb25zdCB7IHRva2VuLCB1c2VybmFtZSwgbWFpbCB9ID0gcmVxLnF1ZXJ5O1xuICAgIGNvbnN0IGFwcElkID0gcHJvY2Vzcy5lbnYuQVBQX0lEIHx8ICdUaWNrZXRGdWNocyc7XG4gICAgY29uc29sZS5sb2coYEFwcElEOiAke2FwcElkfWApO1xuICAgIGNvbnN0IGNvbmZpZyA9IENvbmZpZy5nZXQoYXBwSWQpO1xuXG4gICAgaWYgKCFjb25maWcpIHtcbiAgICAgIGNvbnNvbGUubG9nKFwiUHVibGljQXBpUm91dGVyLmpzIEwuIDE4XCIpO1xuICAgICAgdGhpcy5pbnZhbGlkUmVxdWVzdCgpO1xuICAgIH1cblxuICAgIGlmICghY29uZmlnLnB1YmxpY1NlcnZlclVSTCkge1xuICAgICAgcmV0dXJuIHRoaXMubWlzc2luZ1B1YmxpY1NlcnZlclVSTCgpO1xuICAgIH1cblxuICAgIGlmICghdG9rZW4gfHwgIXVzZXJuYW1lfHwgIW1haWwpIHtcbiAgICAgIGNvbnNvbGUubG9nKGBNYWlsYWRyZXNzZTogJHttYWlsfWApO1xuICAgICAgY29uc29sZS5sb2coXCJQdWJsaWNBcGlSb3V0ZXIuanMgTC4gMjhcIik7XG4gICAgICByZXR1cm4gdGhpcy5pbnZhbGlkTGluayhyZXEpO1xuICAgIH1cblxuICAgIGNvbnN0IHVzZXJDb250cm9sbGVyID0gY29uZmlnLnVzZXJDb250cm9sbGVyO1xuICAgIHJldHVybiB1c2VyQ29udHJvbGxlci52ZXJpZnlFbWFpbCh1c2VybmFtZSwgdG9rZW4pLnRoZW4oXG4gICAgICAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHBhcmFtcyA9IHFzLnN0cmluZ2lmeSh7IG1haWwgfSk7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe1xuICAgICAgICAgIHN0YXR1czogMzAyLFxuICAgICAgICAgIGxvY2F0aW9uOiBgJHtjb25maWcudmVyaWZ5RW1haWxTdWNjZXNzVVJMfT8ke3BhcmFtc31gLFxuICAgICAgICB9KTtcbiAgICAgIH0sXG4gICAgICAoKSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmludmFsaWRWZXJpZmljYXRpb25MaW5rKHJlcSk7XG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIHJlc2VuZFZlcmlmaWNhdGlvbkVtYWlsKHJlcSkge1xuICAgIGNvbnNvbGUubG9nKFwiUmVxdWVzdFwiICsgSlNPTi5zdHJpbmdpZnkocmVxLmJvZHkpKTtcbiAgICBjb25zdCB1c2VybmFtZSA9IHJlcS5ib2R5LnVzZXJuYW1lO1xuICAgIGNvbnN0IGFwcElkID0gcHJvY2Vzcy5lbnYuQVBQX0lEIHx8ICdUaWNrZXRGdWNocyc7XG4gICAgY29uc29sZS5sb2coYEFwcElEOiAke2FwcElkfWApO1xuXG5cbiAgICBjb25zdCBjb25maWcgPSBDb25maWcuZ2V0KGFwcElkKTtcblxuICAgIGlmICghY29uZmlnKSB7XG4gICAgICBjb25zb2xlLmxvZyhcIlB1YmxpY0FwaVJvdXRlci5qcyBMLiA1MVwiKTtcbiAgICAgIHRoaXMuaW52YWxpZFJlcXVlc3QoKTtcbiAgICB9XG5cbiAgICBpZiAoIWNvbmZpZy5wdWJsaWNTZXJ2ZXJVUkwpIHtcbiAgICAgIHJldHVybiB0aGlzLm1pc3NpbmdQdWJsaWNTZXJ2ZXJVUkwoKTtcbiAgICB9XG5cbiAgICBpZiAoIXVzZXJuYW1lKSB7XG4gICAgICBjb25zb2xlLmxvZyhcIlVzZXJuYW1lOlwiICsgdXNlcm5hbWUpO1xuICAgICAgY29uc29sZS5sb2coXCJQdWJsaWNBcGlSb3V0ZXIuanMgTC4gNjhcIik7XG4gICAgICByZXR1cm4gdGhpcy5pbnZhbGlkTGluayhyZXEpO1xuICAgIH1cblxuICAgIGNvbnN0IHVzZXJDb250cm9sbGVyID0gY29uZmlnLnVzZXJDb250cm9sbGVyO1xuXG4gICAgcmV0dXJuIHVzZXJDb250cm9sbGVyLnJlc2VuZFZlcmlmaWNhdGlvbkVtYWlsKHVzZXJuYW1lKS50aGVuKFxuICAgICAgKCkgPT4ge1xuICAgICAgICBjb25zdCBwYXJhbXMgPSBxcy5zdHJpbmdpZnkoeyB1c2VybmFtZSB9KTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7XG4gICAgICAgICAgc3RhdHVzOiAzMDIsXG4gICAgICAgICAgbG9jYXRpb246IGAke2NvbmZpZy5saW5rU2VuZFN1Y2Nlc3NVUkx9PyR7cGFyYW1zfWAsXG4gICAgICAgIH0pO1xuICAgICAgfSxcbiAgICAgICgpID0+IHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7XG4gICAgICAgICAgc3RhdHVzOiAzMDIsXG4gICAgICAgICAgbG9jYXRpb246IGAke2NvbmZpZy5saW5rU2VuZEZhaWxVUkx9YCxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIGNoYW5nZVBhc3N3b3JkKHJlcSkge1xuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IGFwcElkID0gcHJvY2Vzcy5lbnYuQVBQX0lEIHx8ICdUaWNrZXRGdWNocyc7XG4gICAgICBjb25zdCBjb25maWcgPSBDb25maWcuZ2V0KGFwcElkKTtcblxuICAgICAgaWYgKCFjb25maWcpIHtcbiAgICAgICAgY29uc29sZS5sb2coXCJQdWJsaWNBcGlSb3V0ZXIuanMgTC4gOTVcIik7XG4gICAgICAgIHRoaXMuaW52YWxpZFJlcXVlc3QoKTtcbiAgICAgIH1cblxuICAgICAgaWYgKCFjb25maWcucHVibGljU2VydmVyVVJMKSB7XG4gICAgICAgIHJldHVybiByZXNvbHZlKHtcbiAgICAgICAgICBzdGF0dXM6IDQwNCxcbiAgICAgICAgICB0ZXh0OiAnTm90IGZvdW5kLicsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgLy8gU2hvdWxkIHdlIGtlZXAgdGhlIGZpbGUgaW4gbWVtb3J5IG9yIGxlYXZlIGxpa2UgdGhhdD9cbiAgICAgIGZzLnJlYWRGaWxlKFxuICAgICAgICBwYXRoLnJlc29sdmUodmlld3MsICdjaG9vc2VfcGFzc3dvcmQnKSxcbiAgICAgICAgJ3V0Zi04JyxcbiAgICAgICAgKGVyciwgZGF0YSkgPT4ge1xuICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgIHJldHVybiByZWplY3QoZXJyKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgZGF0YSA9IGRhdGEucmVwbGFjZShcbiAgICAgICAgICAgICdQQVJTRV9TRVJWRVJfVVJMJyxcbiAgICAgICAgICAgIGAnJHtjb25maWcucHVibGljU2VydmVyVVJMfSdgXG4gICAgICAgICAgKTtcbiAgICAgICAgICByZXNvbHZlKHtcbiAgICAgICAgICAgIHRleHQ6IGRhdGEsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICByZXF1ZXN0UmVzZXRQYXNzd29yZChyZXEpIHtcbiAgICBjb25zdCBhcHBJZCA9IHByb2Nlc3MuZW52LkFQUF9JRCB8fCAnVGlja2V0RnVjaHMnO1xuICAgIGNvbnNvbGUubG9nKGBBcHBJRDogJHthcHBJZH1gKTtcbiAgICBjb25zdCBjb25maWcgPSBDb25maWcuZ2V0KGFwcElkKTtcblxuXG4gICAgaWYgKCFjb25maWcpIHtcbiAgICAgIGNvbnNvbGUubG9nKFwiUHVibGljQXBpUm91dGVyLmpzIEwuIDEyMFwiKTtcbiAgICAgIHRoaXMuaW52YWxpZFJlcXVlc3QoKTtcbiAgICB9XG5cbiAgICBpZiAoIWNvbmZpZy5wdWJsaWNTZXJ2ZXJVUkwpIHtcbiAgICAgIHJldHVybiB0aGlzLm1pc3NpbmdQdWJsaWNTZXJ2ZXJVUkwoKTtcbiAgICB9XG5cbiAgICBjb25zdCB7IHVzZXJuYW1lLCB0b2tlbiwgbWFpbCB9ID0gcmVxLnF1ZXJ5O1xuXG4gICAgaWYgKCF1c2VybmFtZSB8fCAhdG9rZW4gfHwgIW1haWwpIHtcbiAgICAgIGNvbnNvbGUubG9nKGBNYWlsYWRyZXNzZTogJHttYWlsfWApO1xuICAgICAgY29uc29sZS5sb2coXCJQdWJsaWNBcGlSb3V0ZXIuanMgTC4gMjhcIik7XG4gICAgICByZXR1cm4gdGhpcy5pbnZhbGlkTGluayhyZXEpO1xuICAgIH1cblxuICAgIHJldHVybiBjb25maWcudXNlckNvbnRyb2xsZXIuY2hlY2tSZXNldFRva2VuVmFsaWRpdHkodXNlcm5hbWUsIHRva2VuKS50aGVuKFxuICAgICAgKCkgPT4ge1xuICAgICAgICBjb25zdCBwYXJhbXMgPSBxcy5zdHJpbmdpZnkoe1xuICAgICAgICAgIHRva2VuLFxuICAgICAgICAgIG1haWw6IG1haWwsXG4gICAgICAgICAgdXNlcm5hbWUsXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHtcbiAgICAgICAgICBzdGF0dXM6IDMwMixcbiAgICAgICAgICBsb2NhdGlvbjogYCR7Y29uZmlnLmNob29zZVBhc3N3b3JkVVJMfT8ke3BhcmFtc31gLFxuICAgICAgICB9KTtcbiAgICAgIH0sXG4gICAgICAoKSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmludmFsaWRMaW5rKHJlcSk7XG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG5cbiAgcmVzZXRQYXNzd29yZChyZXEpIHtcbiAgICBjb25zdCBhcHBJZCA9IHByb2Nlc3MuZW52LkFQUF9JRCB8fCAnVGlja2V0RnVjaHMnO1xuICAgIGNvbnNvbGUubG9nKGBBcHBJRDogJHthcHBJZH1gKTtcbiAgICBjb25zdCBjb25maWcgPSBDb25maWcuZ2V0KGFwcElkKTtcblxuICAgIGlmICghY29uZmlnKSB7XG4gICAgICBjb25zb2xlLmxvZyhcIlB1YmxpY0FwaVJvdXRlci5qcyBMLiAxNTdcIik7XG4gICAgICB0aGlzLmludmFsaWRSZXF1ZXN0KCk7XG4gICAgfVxuXG4gICAgaWYgKCFjb25maWcucHVibGljU2VydmVyVVJMKSB7XG4gICAgICByZXR1cm4gdGhpcy5taXNzaW5nUHVibGljU2VydmVyVVJMKCk7XG4gICAgfVxuXG4gICAgY29uc3QgeyB1c2VybmFtZSwgdG9rZW4sIG5ld19wYXNzd29yZCwgbWFpbCB9ID0gcmVxLmJvZHk7XG5cbiAgICBpZiAoIXVzZXJuYW1lIHx8ICF0b2tlbiB8fCAhbmV3X3Bhc3N3b3JkIHx8ICFtYWlsKSB7XG4gICAgICBjb25zb2xlLmxvZyhcIlB1YmxpY0FwaVJvdXRlci5qcyBMLiAxODVcIik7XG4gICAgICByZXR1cm4gdGhpcy5pbnZhbGlkTGluayhyZXEpO1xuICAgIH1cblxuICAgIHJldHVybiBjb25maWcudXNlckNvbnRyb2xsZXJcbiAgICAgIC51cGRhdGVQYXNzd29yZCh1c2VybmFtZSwgdG9rZW4sIG5ld19wYXNzd29yZClcbiAgICAgIC50aGVuKFxuICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgY29uc3QgcGFyYW1zID0gcXMuc3RyaW5naWZ5KHsgbWFpbDogbWFpbCB9KTtcbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHtcbiAgICAgICAgICAgIHN0YXR1czogMzAyLFxuICAgICAgICAgICAgbG9jYXRpb246IGAke2NvbmZpZy5wYXNzd29yZFJlc2V0U3VjY2Vzc1VSTH0/JHtwYXJhbXN9YCxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSxcbiAgICAgICAgZXJyID0+IHtcbiAgICAgICAgICBjb25zdCBwYXJhbXMgPSBxcy5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgdXNlcm5hbWU6IHVzZXJuYW1lLFxuICAgICAgICAgICAgdG9rZW46IHRva2VuLFxuICAgICAgICAgICAgaWQ6IGNvbmZpZy5hcHBsaWNhdGlvbklkLFxuICAgICAgICAgICAgZXJyb3I6IGVycixcbiAgICAgICAgICAgIG1haWw6IG1haWwsXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7XG4gICAgICAgICAgICBzdGF0dXM6IDMwMixcbiAgICAgICAgICAgIGxvY2F0aW9uOiBgJHtjb25maWcuY2hvb3NlUGFzc3dvcmRVUkx9PyR7cGFyYW1zfWAsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICk7XG4gIH1cblxuICBpbnZhbGlkTGluayhyZXEpIHtcbiAgICB2YXIgY29uZmlnID0gbnVsbDtcbiAgICBjb25zb2xlLmxvZyhcIlB1YmxpY0FwaVJvdXRlci5qcyBMLiAyMTVcIik7XG4gICAgY29uc29sZS5sb2coYHJlcTogJHtyZXF9YCk7XG4gICAgaWYocmVxID09PSB1bmRlZmluZWQpIHtcbiAgICBjb25zdCBhcHBJZCA9IHByb2Nlc3MuZW52LkFQUF9JRCB8fCAnVGlja2V0RnVjaHMnO1xuICAgIGNvbnNvbGUubG9nKGBBcHBJRDogJHthcHBJZH1gKTtcbiAgICBjb25maWcgPSBDb25maWcuZ2V0KGFwcElkKTtcbiAgICBjb25zb2xlLmxvZyhgY29uZmlnOiAke2NvbmZpZ31gKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICBjb25maWcgPSByZXEuY29uZmlnO1xuICAgICAgY29uc29sZS5sb2coYGNvbmZpZzogJHtjb25maWd9YCk7XG4gICAgfVxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe1xuICAgICAgc3RhdHVzOiAzMDIsXG4gICAgICBsb2NhdGlvbjogY29uZmlnLmludmFsaWRMaW5rVVJMLFxuICAgIH0pO1xuICB9XG5cbiAgaW52YWxpZFZlcmlmaWNhdGlvbkxpbmsocmVxKSB7XG4gICAgdmFyIGNvbmZpZyA9IHJlcS5jb25maWc7XG4gICAgY29uc29sZS5sb2coXCJQdWJsaWNBcGlSb3V0ZXIuanMgTC4gMjM1XCIpO1xuICAgIGNvbnNvbGUubG9nKGByZXE6ICR7cmVxfWApO1xuICAgIGlmKGNvbmZpZyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBjb25zdCBhcHBJZCA9IHByb2Nlc3MuZW52LkFQUF9JRCB8fCAnVGlja2V0RnVjaHMnO1xuICAgICAgY29uc29sZS5sb2coYEFwcElEOiAke2FwcElkfWApO1xuICAgICAgY29uZmlnID0gQ29uZmlnLmdldChhcHBJZCk7XG4gICAgICBjb25zb2xlLmxvZyhgY29uZmlnOiAke2NvbmZpZ31gKTtcbiAgICAgIH1cbiAgICAgIGNvbnNvbGUubG9nKGBjb25maWc6ICR7Y29uZmlnfWApO1xuICAgIGlmIChyZXEucXVlcnkudXNlcm5hbWUpIHtcbiAgICAgIGNvbnN0IHBhcmFtcyA9IHFzLnN0cmluZ2lmeSh7XG4gICAgICAgIHVzZXJuYW1lOiByZXEucXVlcnkudXNlcm5hbWUsXG4gICAgICB9KTtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe1xuICAgICAgICBzdGF0dXM6IDMwMixcbiAgICAgICAgbG9jYXRpb246IGAke2NvbmZpZy5pbnZhbGlkVmVyaWZpY2F0aW9uTGlua1VSTH0/JHtwYXJhbXN9YCxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zb2xlLmxvZyhcIlB1YmxpY0FwaVJvdXRlci5qcyBMLiAyNTNcIik7XG4gICAgICByZXR1cm4gdGhpcy5pbnZhbGlkTGluayhyZXEpO1xuICAgIH1cbiAgfVxuXG4gIG1pc3NpbmdQdWJsaWNTZXJ2ZXJVUkwoKSB7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7XG4gICAgICB0ZXh0OiAnTm90IGZvdW5kLicsXG4gICAgICBzdGF0dXM6IDQwNCxcbiAgICB9KTtcbiAgfVxuXG4gIGludmFsaWRSZXF1ZXN0KCkge1xuICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKCk7XG4gICAgZXJyb3Iuc3RhdHVzID0gNDAzO1xuICAgIGVycm9yLm1lc3NhZ2UgPSAndW5hdXRob3JpemVkJztcbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxuXG4gIHNldENvbmZpZyhyZXEpIHtcblxuICAgIHZhciBzZWVuID0gW107XG4gICAgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkocmVxLCBmdW5jdGlvbihrZXksIHZhbCkge1xuICAgICAgaWYgKHZhbCAhPSBudWxsICYmIHR5cGVvZiB2YWwgPT0gXCJvYmplY3RcIikge1xuICAgICAgICAgICBpZiAoc2Vlbi5pbmRleE9mKHZhbCkgPj0gMCkge1xuICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICB9XG4gICAgICAgICAgIHNlZW4ucHVzaCh2YWwpO1xuICAgICAgIH1cbiAgICAgICByZXR1cm4gdmFsO1xuICAgfSkpO1xuXG5cblxuICAgIGNvbnN0IGFwcElkID0gcHJvY2Vzcy5lbnYuQVBQX0lEIHx8ICdUaWNrZXRGdWNocyc7XG4gICAgcmVxLmNvbmZpZyA9IENvbmZpZy5nZXQoYXBwSWQpO1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgfVxuXG4gIG1vdW50Um91dGVzKCkge1xuICAgIHRoaXMucm91dGUoXG4gICAgICAnR0VUJyxcbiAgICAgICcvdmVyaWZ5X2VtYWlsJyxcbiAgICAgIHJlcSA9PiB7XG4gICAgICAgIHRoaXMuc2V0Q29uZmlnKHJlcSk7XG4gICAgICB9LFxuICAgICAgcmVxID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMudmVyaWZ5RW1haWwocmVxKTtcbiAgICAgIH1cbiAgICApO1xuXG4gICAgdGhpcy5yb3V0ZShcbiAgICAgICdQT1NUJyxcbiAgICAgICcvcmVzZW5kX3ZlcmlmaWNhdGlvbl9lbWFpbCcsXG4gICAgICByZXEgPT4ge1xuICAgICAgICB0aGlzLnNldENvbmZpZyhyZXEpO1xuICAgICAgfSxcbiAgICAgIHJlcSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLnJlc2VuZFZlcmlmaWNhdGlvbkVtYWlsKHJlcSk7XG4gICAgICB9XG4gICAgKTtcblxuICAgIHRoaXMucm91dGUoJ0dFVCcsICcvY2hvb3NlX3Bhc3N3b3JkJywgcmVxID0+IHtcbiAgICAgIHJldHVybiB0aGlzLmNoYW5nZVBhc3N3b3JkKHJlcSk7XG4gICAgfSk7XG5cbiAgICB0aGlzLnJvdXRlKFxuICAgICAgJ1BPU1QnLFxuICAgICAgJy9yZXF1ZXN0X3Bhc3N3b3JkX3Jlc2V0JyxcbiAgICAgIHJlcSA9PiB7XG4gICAgICAgIHRoaXMuc2V0Q29uZmlnKHJlcSk7XG4gICAgICB9LFxuICAgICAgcmVxID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMucmVzZXRQYXNzd29yZChyZXEpO1xuICAgICAgfVxuICAgICk7XG5cbiAgICB0aGlzLnJvdXRlKFxuICAgICAgJ0dFVCcsXG4gICAgICAnL3JlcXVlc3RfcGFzc3dvcmRfcmVzZXQnLFxuICAgICAgcmVxID0+IHtcbiAgICAgICAgdGhpcy5zZXRDb25maWcocmVxKTtcbiAgICAgIH0sXG4gICAgICByZXEgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5yZXF1ZXN0UmVzZXRQYXNzd29yZChyZXEpO1xuICAgICAgfVxuICAgICk7XG4gIH1cblxuICBleHByZXNzUm91dGVyKCkge1xuICAgIGNvbnN0IHJvdXRlciA9IGV4cHJlc3MuUm91dGVyKCk7XG4gICAgcm91dGVyLnVzZSgnL2FwcHMnLCBleHByZXNzLnN0YXRpYyhwdWJsaWNfaHRtbCkpO1xuICAgIHJvdXRlci51c2UoJy8nLCBzdXBlci5leHByZXNzUm91dGVyKCkpO1xuICAgIHJldHVybiByb3V0ZXI7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgUHVibGljQVBJUm91dGVyO1xuIl19