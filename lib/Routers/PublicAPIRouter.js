"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.PublicAPIRouter = void 0;

var _PromiseRouter = _interopRequireDefault(require("../PromiseRouter"));

var _Config = _interopRequireDefault(require("../Config"));

var _express = _interopRequireDefault(require("express"));

var _path = _interopRequireDefault(require("path"));

var _fs = _interopRequireDefault(require("fs"));

var _querystring = _interopRequireDefault(require("querystring"));

var _node = require("parse/node");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const public_html = _path.default.resolve(__dirname, '../../public_html');

const views = _path.default.resolve(__dirname, '../../views');

class PublicAPIRouter extends _PromiseRouter.default {
  verifyEmail(req) {
    const {
      username,
      token: rawToken,
      mail
    } = req.query;
    const token = rawToken && typeof rawToken !== 'string' ? rawToken.toString() : rawToken;
    const appId = process.env.APP_ID;

    const config = _Config.default.get(appId);

    if (!config) {
      this.invalidRequest();
    }

    if (!config.publicServerURL) {
      return this.missingPublicServerURL();
    }

    if (!token || !username || !mail) {
      console.log(`Mailadresse: ${mail}`);
      return this.invalidLink(req);
    }

    const userController = config.userController;
    return userController.verifyEmail(username, token).then(() => {
      const params = _querystring.default.stringify({
        mail
      });

      return Promise.resolve({
        status: 302,
        location: `${config.verifyEmailSuccessURL}?${params}`
      });
    }, () => {
      return this.invalidVerificationLink(req);
    });
  }

  resendVerificationEmail(req) {
    const username = req.body.username;
    const appId = process.env.APP_ID;

    const config = _Config.default.get(appId);

    if (!config) {
      this.invalidRequest();
    }

    if (!config.publicServerURL) {
      return this.missingPublicServerURL();
    }

    if (!username) {
      return this.invalidLink(req);
    }

    const userController = config.userController;
    return userController.resendVerificationEmail(username).then(() => {
      const params = _querystring.default.stringify({
        username
      });

      return Promise.resolve({
        status: 302,
        location: `${config.linkSendSuccessURL}?${params}`
      });
    }, () => {
      return Promise.resolve({
        status: 302,
        location: `${config.linkSendFailURL}`
      });
    });
  }

  changePassword() {
    return new Promise((resolve, reject) => {
      const config = _Config.default.get(process.env.APP_ID);

      if (!config) {
        this.invalidRequest();
      }

      if (!config.publicServerURL) {
        return resolve({
          status: 404,
          text: 'Not found.'
        });
      } // Should we keep the file in memory or leave like that?


      _fs.default.readFile(_path.default.resolve(views, 'choose_password'), 'utf-8', (err, data) => {
        if (err) {
          return reject(err);
        }

        data = data.replace('PARSE_SERVER_URL', `'${config.publicServerURL}'`);
        resolve({
          text: data
        });
      });
    });
  }

  requestResetPassword(req) {
    const config = _Config.default.get(process.env.APP_ID);

    if (!config) {
      this.invalidRequest();
    }

    if (!config.publicServerURL) {
      return this.missingPublicServerURL();
    }

    const {
      username,
      token: rawToken,
      mail
    } = req.query;
    const token = rawToken && typeof rawToken !== 'string' ? rawToken.toString() : rawToken;

    if (!username || !token || !mail) {
      console.log(`Mailadresse: ${mail}`);
      return this.invalidLink(req);
    }

    return config.userController.checkResetTokenValidity(username, token).then(() => {
      const params = _querystring.default.stringify({
        token,
        mail: mail,
        id: config.applicationId,
        username,
        app: config.appName
      });

      return Promise.resolve({
        status: 302,
        location: `${config.choosePasswordURL}?${params}`
      });
    }, () => {
      return this.invalidLink(req);
    });
  }

  resetPassword(req) {
    const config = _Config.default.get(process.env.APP_ID);

    if (!config) {
      this.invalidRequest();
    }

    if (!config.publicServerURL) {
      return this.missingPublicServerURL();
    }

    const {
      username,
      new_password,
      token: rawToken,
      mail
    } = req.body;
    const token = rawToken && typeof rawToken !== 'string' ? rawToken.toString() : rawToken;

    if ((!username || !token || !new_password || !mail) && req.xhr === false) {
      console.log('PublicApiRouter.js L. 185');
      return this.invalidLink(req);
    }

    if (!username) {
      throw new _node.Parse.Error(_node.Parse.Error.USERNAME_MISSING, 'Missing username');
    }

    if (!token) {
      throw new _node.Parse.Error(_node.Parse.Error.OTHER_CAUSE, 'Missing token');
    }

    if (!new_password) {
      throw new _node.Parse.Error(_node.Parse.Error.PASSWORD_MISSING, 'Missing password');
    }

    if (!mail) {
      throw new _node.Parse.Error(_node.Parse.Error.EMAIL_MISSING, 'Missing Mail');
    }

    return config.userController.updatePassword(username, token, new_password).then(() => {
      return Promise.resolve({
        success: true
      });
    }, err => {
      return Promise.resolve({
        success: false,
        err
      });
    }).then(result => {
      const params = _querystring.default.stringify({
        username: username,
        token: token,
        id: config.applicationId,
        error: result.err,
        app: config.appName,
        mail: mail
      });

      if (req.xhr) {
        if (result.success) {
          return Promise.resolve({
            status: 200,
            response: 'Password successfully reset'
          });
        }

        if (result.err) {
          throw new _node.Parse.Error(_node.Parse.Error.OTHER_CAUSE, `${result.err}`);
        }
      }

      const encodedUsername = encodeURIComponent(mail);
      const location = result.success ? `${config.passwordResetSuccessURL}?mail=${encodedUsername}` : `${config.choosePasswordURL}?${params}`;
      return Promise.resolve({
        status: 302,
        location
      });
    });
  }

  invalidLink(req) {
    return Promise.resolve({
      status: 302,
      location: req.config.invalidLinkURL
    });
  }

  invalidVerificationLink(req) {
    const config = req.config;

    if (req.query.username && req.params.appId) {
      const params = _querystring.default.stringify({
        username: req.query.username
      });

      return Promise.resolve({
        status: 302,
        location: `${config.invalidVerificationLinkURL}?${params}`
      });
    } else {
      return this.invalidLink(req);
    }
  }

  missingPublicServerURL() {
    return Promise.resolve({
      text: 'Not found.',
      status: 404
    });
  }

  invalidRequest() {
    const error = new Error();
    error.status = 403;
    error.message = 'unauthorized';
    throw error;
  }

  setConfig(req) {
    req.config = _Config.default.get(process.env.APP_ID);
    return Promise.resolve();
  }

  mountRoutes() {
    this.route('GET', '/verify_email', req => {
      this.setConfig(req);
    }, req => {
      return this.verifyEmail(req);
    });
    this.route('POST', '/resend_verification_email', req => {
      this.setConfig(req);
    }, req => {
      return this.resendVerificationEmail(req);
    });
    this.route('GET', '/choose_password', () => {
      return this.changePassword();
    });
    this.route('POST', '/request_password_reset', req => {
      this.setConfig(req);
    }, req => {
      return this.resetPassword(req);
    });
    this.route('GET', '/request_password_reset', req => {
      this.setConfig(req);
    }, req => {
      return this.requestResetPassword(req);
    });
  }

  expressRouter() {
    const router = _express.default.Router();

    router.use('/apps', _express.default.static(public_html));
    router.use('/', super.expressRouter());
    return router;
  }

}

exports.PublicAPIRouter = PublicAPIRouter;
var _default = PublicAPIRouter;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Sb3V0ZXJzL1B1YmxpY0FQSVJvdXRlci5qcyJdLCJuYW1lcyI6WyJwdWJsaWNfaHRtbCIsInBhdGgiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwidmlld3MiLCJQdWJsaWNBUElSb3V0ZXIiLCJQcm9taXNlUm91dGVyIiwidmVyaWZ5RW1haWwiLCJyZXEiLCJ1c2VybmFtZSIsInRva2VuIiwicmF3VG9rZW4iLCJtYWlsIiwicXVlcnkiLCJ0b1N0cmluZyIsImFwcElkIiwicHJvY2VzcyIsImVudiIsIkFQUF9JRCIsImNvbmZpZyIsIkNvbmZpZyIsImdldCIsImludmFsaWRSZXF1ZXN0IiwicHVibGljU2VydmVyVVJMIiwibWlzc2luZ1B1YmxpY1NlcnZlclVSTCIsImNvbnNvbGUiLCJsb2ciLCJpbnZhbGlkTGluayIsInVzZXJDb250cm9sbGVyIiwidGhlbiIsInBhcmFtcyIsInFzIiwic3RyaW5naWZ5IiwiUHJvbWlzZSIsInN0YXR1cyIsImxvY2F0aW9uIiwidmVyaWZ5RW1haWxTdWNjZXNzVVJMIiwiaW52YWxpZFZlcmlmaWNhdGlvbkxpbmsiLCJyZXNlbmRWZXJpZmljYXRpb25FbWFpbCIsImJvZHkiLCJsaW5rU2VuZFN1Y2Nlc3NVUkwiLCJsaW5rU2VuZEZhaWxVUkwiLCJjaGFuZ2VQYXNzd29yZCIsInJlamVjdCIsInRleHQiLCJmcyIsInJlYWRGaWxlIiwiZXJyIiwiZGF0YSIsInJlcGxhY2UiLCJyZXF1ZXN0UmVzZXRQYXNzd29yZCIsImNoZWNrUmVzZXRUb2tlblZhbGlkaXR5IiwiaWQiLCJhcHBsaWNhdGlvbklkIiwiYXBwIiwiYXBwTmFtZSIsImNob29zZVBhc3N3b3JkVVJMIiwicmVzZXRQYXNzd29yZCIsIm5ld19wYXNzd29yZCIsInhociIsIlBhcnNlIiwiRXJyb3IiLCJVU0VSTkFNRV9NSVNTSU5HIiwiT1RIRVJfQ0FVU0UiLCJQQVNTV09SRF9NSVNTSU5HIiwiRU1BSUxfTUlTU0lORyIsInVwZGF0ZVBhc3N3b3JkIiwic3VjY2VzcyIsInJlc3VsdCIsImVycm9yIiwicmVzcG9uc2UiLCJlbmNvZGVkVXNlcm5hbWUiLCJlbmNvZGVVUklDb21wb25lbnQiLCJwYXNzd29yZFJlc2V0U3VjY2Vzc1VSTCIsImludmFsaWRMaW5rVVJMIiwiaW52YWxpZFZlcmlmaWNhdGlvbkxpbmtVUkwiLCJtZXNzYWdlIiwic2V0Q29uZmlnIiwibW91bnRSb3V0ZXMiLCJyb3V0ZSIsImV4cHJlc3NSb3V0ZXIiLCJyb3V0ZXIiLCJleHByZXNzIiwiUm91dGVyIiwidXNlIiwic3RhdGljIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxNQUFNQSxXQUFXLEdBQUdDLGNBQUtDLE9BQUwsQ0FBYUMsU0FBYixFQUF3QixtQkFBeEIsQ0FBcEI7O0FBQ0EsTUFBTUMsS0FBSyxHQUFHSCxjQUFLQyxPQUFMLENBQWFDLFNBQWIsRUFBd0IsYUFBeEIsQ0FBZDs7QUFFTyxNQUFNRSxlQUFOLFNBQThCQyxzQkFBOUIsQ0FBNEM7QUFDakRDLEVBQUFBLFdBQVcsQ0FBQ0MsR0FBRCxFQUFNO0FBQ2YsVUFBTTtBQUFFQyxNQUFBQSxRQUFGO0FBQVlDLE1BQUFBLEtBQUssRUFBRUMsUUFBbkI7QUFBNkJDLE1BQUFBO0FBQTdCLFFBQXNDSixHQUFHLENBQUNLLEtBQWhEO0FBQ0EsVUFBTUgsS0FBSyxHQUNUQyxRQUFRLElBQUksT0FBT0EsUUFBUCxLQUFvQixRQUFoQyxHQUEyQ0EsUUFBUSxDQUFDRyxRQUFULEVBQTNDLEdBQWlFSCxRQURuRTtBQUdBLFVBQU1JLEtBQUssR0FBR0MsT0FBTyxDQUFDQyxHQUFSLENBQVlDLE1BQTFCOztBQUNBLFVBQU1DLE1BQU0sR0FBR0MsZ0JBQU9DLEdBQVAsQ0FBV04sS0FBWCxDQUFmOztBQUVBLFFBQUksQ0FBQ0ksTUFBTCxFQUFhO0FBQ1gsV0FBS0csY0FBTDtBQUNEOztBQUVELFFBQUksQ0FBQ0gsTUFBTSxDQUFDSSxlQUFaLEVBQTZCO0FBQzNC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QWY7QUFDRCxLQUxILEVBTUVBLEdBQUcsSUFBSTtBQUNMLGFBQU8sS0FBS2lELGFBQUwsQ0FBbUJqRCxHQUFuQixDQUFQO0FBQ0QsS0FSSDtBQVdBLFNBQUt1RSxLQUFMLENBQ0UsS0FERixFQUVFLHlCQUZGLEVBR0V2RSxHQUFHLElBQUk7QUFDTCxXQUFLcUUsU0FBTCxDQUFlckUsR0FBZjtBQUNELEtBTEgsRUFNRUEsR0FBRyxJQUFJO0FBQ0wsYUFBTyxLQUFLMEMsb0JBQUwsQ0FBMEIxQyxHQUExQixDQUFQO0FBQ0QsS0FSSDtBQVVEOztBQUVEd0UsRUFBQUEsYUFBYSxHQUFHO0FBQ2QsVUFBTUMsTUFBTSxHQUFHQyxpQkFBUUMsTUFBUixFQUFmOztBQUNBRixJQUFBQSxNQUFNLENBQUNHLEdBQVAsQ0FBVyxPQUFYLEVBQW9CRixpQkFBUUcsTUFBUixDQUFlckYsV0FBZixDQUFwQjtBQUNBaUYsSUFBQUEsTUFBTSxDQUFDRyxHQUFQLENBQVcsR0FBWCxFQUFnQixNQUFNSixhQUFOLEVBQWhCO0FBQ0EsV0FBT0MsTUFBUDtBQUNEOztBQXhVZ0Q7OztlQTJVcEM1RSxlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFByb21pc2VSb3V0ZXIgZnJvbSAnLi4vUHJvbWlzZVJvdXRlcic7XG5pbXBvcnQgQ29uZmlnIGZyb20gJy4uL0NvbmZpZyc7XG5pbXBvcnQgZXhwcmVzcyBmcm9tICdleHByZXNzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBxcyBmcm9tICdxdWVyeXN0cmluZyc7XG5pbXBvcnQgeyBQYXJzZSB9IGZyb20gJ3BhcnNlL25vZGUnO1xuXG5jb25zdCBwdWJsaWNfaHRtbCA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLi8uLi9wdWJsaWNfaHRtbCcpO1xuY29uc3Qgdmlld3MgPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4vLi4vdmlld3MnKTtcblxuZXhwb3J0IGNsYXNzIFB1YmxpY0FQSVJvdXRlciBleHRlbmRzIFByb21pc2VSb3V0ZXIge1xuICB2ZXJpZnlFbWFpbChyZXEpIHtcbiAgICBjb25zdCB7IHVzZXJuYW1lLCB0b2tlbjogcmF3VG9rZW4sIG1haWwgfSA9IHJlcS5xdWVyeTtcbiAgICBjb25zdCB0b2tlbiA9XG4gICAgICByYXdUb2tlbiAmJiB0eXBlb2YgcmF3VG9rZW4gIT09ICdzdHJpbmcnID8gcmF3VG9rZW4udG9TdHJpbmcoKSA6IHJhd1Rva2VuO1xuXG4gICAgY29uc3QgYXBwSWQgPSBwcm9jZXNzLmVudi5BUFBfSUQ7XG4gICAgY29uc3QgY29uZmlnID0gQ29uZmlnLmdldChhcHBJZCk7XG5cbiAgICBpZiAoIWNvbmZpZykge1xuICAgICAgdGhpcy5pbnZhbGlkUmVxdWVzdCgpO1xuICAgIH1cblxuICAgIGlmICghY29uZmlnLnB1YmxpY1NlcnZlclVSTCkge1xuICAgICAgcmV0dXJuIHRoaXMubWlzc2luZ1B1YmxpY1NlcnZlclVSTCgpO1xuICAgIH1cblxuICAgIGlmICghdG9rZW4gfHwgIXVzZXJuYW1lIHx8ICFtYWlsKSB7XG4gICAgICBjb25zb2xlLmxvZyhgTWFpbGFkcmVzc2U6ICR7bWFpbH1gKTtcbiAgICAgIHJldHVybiB0aGlzLmludmFsaWRMaW5rKHJlcSk7XG4gICAgfVxuXG4gICAgY29uc3QgdXNlckNvbnRyb2xsZXIgPSBjb25maWcudXNlckNvbnRyb2xsZXI7XG4gICAgcmV0dXJuIHVzZXJDb250cm9sbGVyLnZlcmlmeUVtYWlsKHVzZXJuYW1lLCB0b2tlbikudGhlbihcbiAgICAgICgpID0+IHtcbiAgICAgICAgY29uc3QgcGFyYW1zID0gcXMuc3RyaW5naWZ5KHsgbWFpbCB9KTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7XG4gICAgICAgICAgc3RhdHVzOiAzMDIsXG4gICAgICAgICAgbG9jYXRpb246IGAke2NvbmZpZy52ZXJpZnlFbWFpbFN1Y2Nlc3NVUkx9PyR7cGFyYW1zfWAsXG4gICAgICAgIH0pO1xuICAgICAgfSxcbiAgICAgICgpID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaW52YWxpZFZlcmlmaWNhdGlvbkxpbmsocmVxKTtcbiAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgcmVzZW5kVmVyaWZpY2F0aW9uRW1haWwocmVxKSB7XG4gICAgY29uc3QgdXNlcm5hbWUgPSByZXEuYm9keS51c2VybmFtZTtcbiAgICBjb25zdCBhcHBJZCA9IHByb2Nlc3MuZW52LkFQUF9JRDtcbiAgICBjb25zdCBjb25maWcgPSBDb25maWcuZ2V0KGFwcElkKTtcblxuICAgIGlmICghY29uZmlnKSB7XG4gICAgICB0aGlzLmludmFsaWRSZXF1ZXN0KCk7XG4gICAgfVxuXG4gICAgaWYgKCFjb25maWcucHVibGljU2VydmVyVVJMKSB7XG4gICAgICByZXR1cm4gdGhpcy5taXNzaW5nUHVibGljU2VydmVyVVJMKCk7XG4gICAgfVxuXG4gICAgaWYgKCF1c2VybmFtZSkge1xuICAgICAgcmV0dXJuIHRoaXMuaW52YWxpZExpbmsocmVxKTtcbiAgICB9XG5cbiAgICBjb25zdCB1c2VyQ29udHJvbGxlciA9IGNvbmZpZy51c2VyQ29udHJvbGxlcjtcblxuICAgIHJldHVybiB1c2VyQ29udHJvbGxlci5yZXNlbmRWZXJpZmljYXRpb25FbWFpbCh1c2VybmFtZSkudGhlbihcbiAgICAgICgpID0+IHtcbiAgICAgICAgY29uc3QgcGFyYW1zID0gcXMuc3RyaW5naWZ5KHsgdXNlcm5hbWUgfSk7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe1xuICAgICAgICAgIHN0YXR1czogMzAyLFxuICAgICAgICAgIGxvY2F0aW9uOiBgJHtjb25maWcubGlua1NlbmRTdWNjZXNzVVJMfT8ke3BhcmFtc31gLFxuICAgICAgICB9KTtcbiAgICAgIH0sXG4gICAgICAoKSA9PiB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe1xuICAgICAgICAgIHN0YXR1czogMzAyLFxuICAgICAgICAgIGxvY2F0aW9uOiBgJHtjb25maWcubGlua1NlbmRGYWlsVVJMfWAsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICk7XG4gIH1cblxuICBjaGFuZ2VQYXNzd29yZCgpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgY29uZmlnID0gQ29uZmlnLmdldChwcm9jZXNzLmVudi5BUFBfSUQpO1xuXG4gICAgICBpZiAoIWNvbmZpZykge1xuICAgICAgICB0aGlzLmludmFsaWRSZXF1ZXN0KCk7XG4gICAgICB9XG5cbiAgICAgIGlmICghY29uZmlnLnB1YmxpY1NlcnZlclVSTCkge1xuICAgICAgICByZXR1cm4gcmVzb2x2ZSh7XG4gICAgICAgICAgc3RhdHVzOiA0MDQsXG4gICAgICAgICAgdGV4dDogJ05vdCBmb3VuZC4nLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIC8vIFNob3VsZCB3ZSBrZWVwIHRoZSBmaWxlIGluIG1lbW9yeSBvciBsZWF2ZSBsaWtlIHRoYXQ/XG4gICAgICBmcy5yZWFkRmlsZShcbiAgICAgICAgcGF0aC5yZXNvbHZlKHZpZXdzLCAnY2hvb3NlX3Bhc3N3b3JkJyksXG4gICAgICAgICd1dGYtOCcsXG4gICAgICAgIChlcnIsIGRhdGEpID0+IHtcbiAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICByZXR1cm4gcmVqZWN0KGVycik7XG4gICAgICAgICAgfVxuICAgICAgICAgIGRhdGEgPSBkYXRhLnJlcGxhY2UoXG4gICAgICAgICAgICAnUEFSU0VfU0VSVkVSX1VSTCcsXG4gICAgICAgICAgICBgJyR7Y29uZmlnLnB1YmxpY1NlcnZlclVSTH0nYFxuICAgICAgICAgICk7XG4gICAgICAgICAgcmVzb2x2ZSh7XG4gICAgICAgICAgICB0ZXh0OiBkYXRhLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgcmVxdWVzdFJlc2V0UGFzc3dvcmQocmVxKSB7XG4gICAgY29uc3QgY29uZmlnID0gQ29uZmlnLmdldChwcm9jZXNzLmVudi5BUFBfSUQpO1xuXG4gICAgaWYgKCFjb25maWcpIHtcbiAgICAgIHRoaXMuaW52YWxpZFJlcXVlc3QoKTtcbiAgICB9XG5cbiAgICBpZiAoIWNvbmZpZy5wdWJsaWNTZXJ2ZXJVUkwpIHtcbiAgICAgIHJldHVybiB0aGlzLm1pc3NpbmdQdWJsaWNTZXJ2ZXJVUkwoKTtcbiAgICB9XG5cbiAgICBjb25zdCB7IHVzZXJuYW1lLCB0b2tlbjogcmF3VG9rZW4sIG1haWwgfSA9IHJlcS5xdWVyeTtcbiAgICBjb25zdCB0b2tlbiA9XG4gICAgICByYXdUb2tlbiAmJiB0eXBlb2YgcmF3VG9rZW4gIT09ICdzdHJpbmcnID8gcmF3VG9rZW4udG9TdHJpbmcoKSA6IHJhd1Rva2VuO1xuXG4gICAgaWYgKCF1c2VybmFtZSB8fCAhdG9rZW4gfHwgIW1haWwpIHtcbiAgICAgIGNvbnNvbGUubG9nKGBNYWlsYWRyZXNzZTogJHttYWlsfWApO1xuICAgICAgcmV0dXJuIHRoaXMuaW52YWxpZExpbmsocmVxKTtcbiAgICB9XG5cbiAgICByZXR1cm4gY29uZmlnLnVzZXJDb250cm9sbGVyLmNoZWNrUmVzZXRUb2tlblZhbGlkaXR5KHVzZXJuYW1lLCB0b2tlbikudGhlbihcbiAgICAgICgpID0+IHtcbiAgICAgICAgY29uc3QgcGFyYW1zID0gcXMuc3RyaW5naWZ5KHtcbiAgICAgICAgICB0b2tlbixcbiAgICAgICAgICBtYWlsOiBtYWlsLFxuICAgICAgICAgIGlkOiBjb25maWcuYXBwbGljYXRpb25JZCxcbiAgICAgICAgICB1c2VybmFtZSxcbiAgICAgICAgICBhcHA6IGNvbmZpZy5hcHBOYW1lLFxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7XG4gICAgICAgICAgc3RhdHVzOiAzMDIsXG4gICAgICAgICAgbG9jYXRpb246IGAke2NvbmZpZy5jaG9vc2VQYXNzd29yZFVSTH0/JHtwYXJhbXN9YCxcbiAgICAgICAgfSk7XG4gICAgICB9LFxuICAgICAgKCkgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5pbnZhbGlkTGluayhyZXEpO1xuICAgICAgfVxuICAgICk7XG4gIH1cblxuICByZXNldFBhc3N3b3JkKHJlcSkge1xuICAgIGNvbnN0IGNvbmZpZyA9IENvbmZpZy5nZXQocHJvY2Vzcy5lbnYuQVBQX0lEKTtcblxuICAgIGlmICghY29uZmlnKSB7XG4gICAgICB0aGlzLmludmFsaWRSZXF1ZXN0KCk7XG4gICAgfVxuXG4gICAgaWYgKCFjb25maWcucHVibGljU2VydmVyVVJMKSB7XG4gICAgICByZXR1cm4gdGhpcy5taXNzaW5nUHVibGljU2VydmVyVVJMKCk7XG4gICAgfVxuXG4gICAgY29uc3QgeyB1c2VybmFtZSwgbmV3X3Bhc3N3b3JkLCB0b2tlbjogcmF3VG9rZW4sIG1haWwgfSA9IHJlcS5ib2R5O1xuICAgIGNvbnN0IHRva2VuID1cbiAgICAgIHJhd1Rva2VuICYmIHR5cGVvZiByYXdUb2tlbiAhPT0gJ3N0cmluZycgPyByYXdUb2tlbi50b1N0cmluZygpIDogcmF3VG9rZW47XG5cbiAgICBpZiAoKCF1c2VybmFtZSB8fCAhdG9rZW4gfHwgIW5ld19wYXNzd29yZCB8fCAhbWFpbCkgJiYgcmVxLnhociA9PT0gZmFsc2UpIHtcbiAgICAgIGNvbnNvbGUubG9nKCdQdWJsaWNBcGlSb3V0ZXIuanMgTC4gMTg1Jyk7XG4gICAgICByZXR1cm4gdGhpcy5pbnZhbGlkTGluayhyZXEpO1xuICAgIH1cblxuICAgIGlmICghdXNlcm5hbWUpIHtcbiAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihQYXJzZS5FcnJvci5VU0VSTkFNRV9NSVNTSU5HLCAnTWlzc2luZyB1c2VybmFtZScpO1xuICAgIH1cblxuICAgIGlmICghdG9rZW4pIHtcbiAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihQYXJzZS5FcnJvci5PVEhFUl9DQVVTRSwgJ01pc3NpbmcgdG9rZW4nKTtcbiAgICB9XG5cbiAgICBpZiAoIW5ld19wYXNzd29yZCkge1xuICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLlBBU1NXT1JEX01JU1NJTkcsICdNaXNzaW5nIHBhc3N3b3JkJyk7XG4gICAgfVxuXG4gICAgaWYgKCFtYWlsKSB7XG4gICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoUGFyc2UuRXJyb3IuRU1BSUxfTUlTU0lORywgJ01pc3NpbmcgTWFpbCcpO1xuICAgIH1cblxuICAgIHJldHVybiBjb25maWcudXNlckNvbnRyb2xsZXJcbiAgICAgIC51cGRhdGVQYXNzd29yZCh1c2VybmFtZSwgdG9rZW4sIG5ld19wYXNzd29yZClcbiAgICAgIC50aGVuKFxuICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7XG4gICAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9LFxuICAgICAgICBlcnIgPT4ge1xuICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe1xuICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgICBlcnIsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIClcbiAgICAgIC50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgIGNvbnN0IHBhcmFtcyA9IHFzLnN0cmluZ2lmeSh7XG4gICAgICAgICAgdXNlcm5hbWU6IHVzZXJuYW1lLFxuICAgICAgICAgIHRva2VuOiB0b2tlbixcbiAgICAgICAgICBpZDogY29uZmlnLmFwcGxpY2F0aW9uSWQsXG4gICAgICAgICAgZXJyb3I6IHJlc3VsdC5lcnIsXG4gICAgICAgICAgYXBwOiBjb25maWcuYXBwTmFtZSxcbiAgICAgICAgICBtYWlsOiBtYWlsLFxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAocmVxLnhocikge1xuICAgICAgICAgIGlmIChyZXN1bHQuc3VjY2Vzcykge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7XG4gICAgICAgICAgICAgIHN0YXR1czogMjAwLFxuICAgICAgICAgICAgICByZXNwb25zZTogJ1Bhc3N3b3JkIHN1Y2Nlc3NmdWxseSByZXNldCcsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHJlc3VsdC5lcnIpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihQYXJzZS5FcnJvci5PVEhFUl9DQVVTRSwgYCR7cmVzdWx0LmVycn1gKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBlbmNvZGVkVXNlcm5hbWUgPSBlbmNvZGVVUklDb21wb25lbnQobWFpbCk7XG4gICAgICAgIGNvbnN0IGxvY2F0aW9uID0gcmVzdWx0LnN1Y2Nlc3NcbiAgICAgICAgICA/IGAke2NvbmZpZy5wYXNzd29yZFJlc2V0U3VjY2Vzc1VSTH0/bWFpbD0ke2VuY29kZWRVc2VybmFtZX1gXG4gICAgICAgICAgOiBgJHtjb25maWcuY2hvb3NlUGFzc3dvcmRVUkx9PyR7cGFyYW1zfWA7XG5cbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7XG4gICAgICAgICAgc3RhdHVzOiAzMDIsXG4gICAgICAgICAgbG9jYXRpb24sXG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gIH1cblxuICBpbnZhbGlkTGluayhyZXEpIHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHtcbiAgICAgIHN0YXR1czogMzAyLFxuICAgICAgbG9jYXRpb246IHJlcS5jb25maWcuaW52YWxpZExpbmtVUkwsXG4gICAgfSk7XG4gIH1cblxuICBpbnZhbGlkVmVyaWZpY2F0aW9uTGluayhyZXEpIHtcbiAgICBjb25zdCBjb25maWcgPSByZXEuY29uZmlnO1xuICAgIGlmIChyZXEucXVlcnkudXNlcm5hbWUgJiYgcmVxLnBhcmFtcy5hcHBJZCkge1xuICAgICAgY29uc3QgcGFyYW1zID0gcXMuc3RyaW5naWZ5KHtcbiAgICAgICAgdXNlcm5hbWU6IHJlcS5xdWVyeS51c2VybmFtZSxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7XG4gICAgICAgIHN0YXR1czogMzAyLFxuICAgICAgICBsb2NhdGlvbjogYCR7Y29uZmlnLmludmFsaWRWZXJpZmljYXRpb25MaW5rVVJMfT8ke3BhcmFtc31gLFxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLmludmFsaWRMaW5rKHJlcSk7XG4gICAgfVxuICB9XG5cbiAgbWlzc2luZ1B1YmxpY1NlcnZlclVSTCgpIHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHtcbiAgICAgIHRleHQ6ICdOb3QgZm91bmQuJyxcbiAgICAgIHN0YXR1czogNDA0LFxuICAgIH0pO1xuICB9XG5cbiAgaW52YWxpZFJlcXVlc3QoKSB7XG4gICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoKTtcbiAgICBlcnJvci5zdGF0dXMgPSA0MDM7XG4gICAgZXJyb3IubWVzc2FnZSA9ICd1bmF1dGhvcml6ZWQnO1xuICAgIHRocm93IGVycm9yO1xuICB9XG5cbiAgc2V0Q29uZmlnKHJlcSkge1xuICAgIHJlcS5jb25maWcgPSBDb25maWcuZ2V0KHByb2Nlc3MuZW52LkFQUF9JRCk7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICB9XG5cbiAgbW91bnRSb3V0ZXMoKSB7XG4gICAgdGhpcy5yb3V0ZShcbiAgICAgICdHRVQnLFxuICAgICAgJy92ZXJpZnlfZW1haWwnLFxuICAgICAgcmVxID0+IHtcbiAgICAgICAgdGhpcy5zZXRDb25maWcocmVxKTtcbiAgICAgIH0sXG4gICAgICByZXEgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy52ZXJpZnlFbWFpbChyZXEpO1xuICAgICAgfVxuICAgICk7XG5cbiAgICB0aGlzLnJvdXRlKFxuICAgICAgJ1BPU1QnLFxuICAgICAgJy9yZXNlbmRfdmVyaWZpY2F0aW9uX2VtYWlsJyxcbiAgICAgIHJlcSA9PiB7XG4gICAgICAgIHRoaXMuc2V0Q29uZmlnKHJlcSk7XG4gICAgICB9LFxuICAgICAgcmVxID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMucmVzZW5kVmVyaWZpY2F0aW9uRW1haWwocmVxKTtcbiAgICAgIH1cbiAgICApO1xuXG4gICAgdGhpcy5yb3V0ZSgnR0VUJywgJy9jaG9vc2VfcGFzc3dvcmQnLCAoKSA9PiB7XG4gICAgICByZXR1cm4gdGhpcy5jaGFuZ2VQYXNzd29yZCgpO1xuICAgIH0pO1xuXG4gICAgdGhpcy5yb3V0ZShcbiAgICAgICdQT1NUJyxcbiAgICAgICcvcmVxdWVzdF9wYXNzd29yZF9yZXNldCcsXG4gICAgICByZXEgPT4ge1xuICAgICAgICB0aGlzLnNldENvbmZpZyhyZXEpO1xuICAgICAgfSxcbiAgICAgIHJlcSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLnJlc2V0UGFzc3dvcmQocmVxKTtcbiAgICAgIH1cbiAgICApO1xuXG4gICAgdGhpcy5yb3V0ZShcbiAgICAgICdHRVQnLFxuICAgICAgJy9yZXF1ZXN0X3Bhc3N3b3JkX3Jlc2V0JyxcbiAgICAgIHJlcSA9PiB7XG4gICAgICAgIHRoaXMuc2V0Q29uZmlnKHJlcSk7XG4gICAgICB9LFxuICAgICAgcmVxID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMucmVxdWVzdFJlc2V0UGFzc3dvcmQocmVxKTtcbiAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgZXhwcmVzc1JvdXRlcigpIHtcbiAgICBjb25zdCByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xuICAgIHJvdXRlci51c2UoJy9hcHBzJywgZXhwcmVzcy5zdGF0aWMocHVibGljX2h0bWwpKTtcbiAgICByb3V0ZXIudXNlKCcvJywgc3VwZXIuZXhwcmVzc1JvdXRlcigpKTtcbiAgICByZXR1cm4gcm91dGVyO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFB1YmxpY0FQSVJvdXRlcjtcbiJdfQ==