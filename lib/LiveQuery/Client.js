"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Client = void 0;

var _logger = _interopRequireDefault(require("../logger"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const dafaultFields = ['className', 'objectId', 'updatedAt', 'createdAt', 'ACL'];

class Client {
  constructor(id, parseWebSocket, hasMasterKey) {
    this.id = id;
    this.parseWebSocket = parseWebSocket;
    this.hasMasterKey = hasMasterKey;
    this.roles = [];
    this.subscriptionInfos = new Map();
    this.pushConnect = this._pushEvent('connected');
    this.pushSubscribe = this._pushEvent('subscribed');
    this.pushUnsubscribe = this._pushEvent('unsubscribed');
    this.pushCreate = this._pushEvent('create');
    this.pushEnter = this._pushEvent('enter');
    this.pushUpdate = this._pushEvent('update');
    this.pushDelete = this._pushEvent('delete');
    this.pushLeave = this._pushEvent('leave');
  }

  static pushResponse(parseWebSocket, message) {
    _logger.default.verbose('Push Response : %j', message);

    parseWebSocket.send(message);
  }

  static pushError(parseWebSocket, code, error, reconnect = true) {
    Client.pushResponse(parseWebSocket, JSON.stringify({
      op: 'error',
      error: error,
      code: code,
      reconnect: reconnect
    }));
  }

  addSubscriptionInfo(requestId, subscriptionInfo) {
    this.subscriptionInfos.set(requestId, subscriptionInfo);
  }

  getSubscriptionInfo(requestId) {
    return this.subscriptionInfos.get(requestId);
  }

  deleteSubscriptionInfo(requestId) {
    return this.subscriptionInfos.delete(requestId);
  }

  _pushEvent(type) {
    return function (subscriptionId, parseObjectJSON) {
      const response = {
        op: type,
        clientId: this.id
      };

      if (typeof subscriptionId !== 'undefined') {
        response['requestId'] = subscriptionId;
      }

      if (typeof parseObjectJSON !== 'undefined') {
        let fields;

        if (this.subscriptionInfos.has(subscriptionId)) {
          fields = this.subscriptionInfos.get(subscriptionId).fields;
        }

        response['object'] = this._toJSONWithFields(parseObjectJSON, fields);
      }

      Client.pushResponse(this.parseWebSocket, JSON.stringify(response));
    };
  }

  _toJSONWithFields(parseObjectJSON, fields) {
    if (!fields) {
      return parseObjectJSON;
    }

    const limitedParseObject = {};

    for (const field of dafaultFields) {
      limitedParseObject[field] = parseObjectJSON[field];
    }

    for (const field of fields) {
      if (field in parseObjectJSON) {
        limitedParseObject[field] = parseObjectJSON[field];
      }
    }

    return limitedParseObject;
  }

}

exports.Client = Client;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9MaXZlUXVlcnkvQ2xpZW50LmpzIl0sIm5hbWVzIjpbImRhZmF1bHRGaWVsZHMiLCJDbGllbnQiLCJjb25zdHJ1Y3RvciIsImlkIiwicGFyc2VXZWJTb2NrZXQiLCJoYXNNYXN0ZXJLZXkiLCJyb2xlcyIsInN1YnNjcmlwdGlvbkluZm9zIiwiTWFwIiwicHVzaENvbm5lY3QiLCJfcHVzaEV2ZW50IiwicHVzaFN1YnNjcmliZSIsInB1c2hVbnN1YnNjcmliZSIsInB1c2hDcmVhdGUiLCJwdXNoRW50ZXIiLCJwdXNoVXBkYXRlIiwicHVzaERlbGV0ZSIsInB1c2hMZWF2ZSIsInB1c2hSZXNwb25zZSIsIm1lc3NhZ2UiLCJsb2dnZXIiLCJ2ZXJib3NlIiwic2VuZCIsInB1c2hFcnJvciIsImNvZGUiLCJlcnJvciIsInJlY29ubmVjdCIsIkpTT04iLCJzdHJpbmdpZnkiLCJvcCIsImFkZFN1YnNjcmlwdGlvbkluZm8iLCJyZXF1ZXN0SWQiLCJzdWJzY3JpcHRpb25JbmZvIiwic2V0IiwiZ2V0U3Vic2NyaXB0aW9uSW5mbyIsImdldCIsImRlbGV0ZVN1YnNjcmlwdGlvbkluZm8iLCJkZWxldGUiLCJ0eXBlIiwic3Vic2NyaXB0aW9uSWQiLCJwYXJzZU9iamVjdEpTT04iLCJyZXNwb25zZSIsImNsaWVudElkIiwiZmllbGRzIiwiaGFzIiwiX3RvSlNPTldpdGhGaWVsZHMiLCJsaW1pdGVkUGFyc2VPYmplY3QiLCJmaWVsZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOzs7O0FBS0EsTUFBTUEsYUFBYSxHQUFHLENBQ3BCLFdBRG9CLEVBRXBCLFVBRm9CLEVBR3BCLFdBSG9CLEVBSXBCLFdBSm9CLEVBS3BCLEtBTG9CLENBQXRCOztBQVFBLE1BQU1DLE1BQU4sQ0FBYTtBQWdCWEMsRUFBQUEsV0FBVyxDQUFDQyxFQUFELEVBQWFDLGNBQWIsRUFBa0NDLFlBQWxDLEVBQXlEO0FBQ2xFLFNBQUtGLEVBQUwsR0FBVUEsRUFBVjtBQUNBLFNBQUtDLGNB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Q0Q7O0FBQ0QxQyxNQUFBQSxNQUFNLENBQUNpQixZQUFQLENBQW9CLEtBQUtkLGNBQXpCLEVBQXlDdUIsSUFBSSxDQUFDQyxTQUFMLENBQWVhLFFBQWYsQ0FBekM7QUFDRCxLQWhCRDtBQWlCRDs7QUFFREksRUFBQUEsaUJBQWlCLENBQUNMLGVBQUQsRUFBdUJHLE1BQXZCLEVBQXlEO0FBQ3hFLFFBQUksQ0FBQ0EsTUFBTCxFQUFhO0FBQ1gsYUFBT0gsZUFBUDtBQUNEOztBQUNELFVBQU1NLGtCQUFrQixHQUFHLEVBQTNCOztBQUNBLFNBQUssTUFBTUMsS0FBWCxJQUFvQi9DLGFBQXBCLEVBQW1DO0FBQ2pDOEMsTUFBQUEsa0JBQWtCLENBQUNDLEtBQUQsQ0FBbEIsR0FBNEJQLGVBQWUsQ0FBQ08sS0FBRCxDQUEzQztBQUNEOztBQUNELFNBQUssTUFBTUEsS0FBWCxJQUFvQkosTUFBcEIsRUFBNEI7QUFDMUIsVUFBSUksS0FBSyxJQUFJUCxlQUFiLEVBQThCO0FBQzVCTSxRQUFBQSxrQkFBa0IsQ0FBQ0MsS0FBRCxDQUFsQixHQUE0QlAsZUFBZSxDQUFDTyxLQUFELENBQTNDO0FBQ0Q7QUFDRjs7QUFDRCxXQUFPRCxrQkFBUDtBQUNEOztBQXBHVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2dnZXIgZnJvbSAnLi4vbG9nZ2VyJztcblxuaW1wb3J0IHR5cGUgeyBGbGF0dGVuZWRPYmplY3REYXRhIH0gZnJvbSAnLi9TdWJzY3JpcHRpb24nO1xuZXhwb3J0IHR5cGUgTWVzc2FnZSA9IHsgW2F0dHI6IHN0cmluZ106IGFueSB9O1xuXG5jb25zdCBkYWZhdWx0RmllbGRzID0gW1xuICAnY2xhc3NOYW1lJyxcbiAgJ29iamVjdElkJyxcbiAgJ3VwZGF0ZWRBdCcsXG4gICdjcmVhdGVkQXQnLFxuICAnQUNMJyxcbl07XG5cbmNsYXNzIENsaWVudCB7XG4gIGlkOiBudW1iZXI7XG4gIHBhcnNlV2ViU29ja2V0OiBhbnk7XG4gIGhhc01hc3RlcktleTogYm9vbGVhbjtcbiAgdXNlcklkOiBzdHJpbmc7XG4gIHJvbGVzOiBBcnJheTxzdHJpbmc+O1xuICBzdWJzY3JpcHRpb25JbmZvczogT2JqZWN0O1xuICBwdXNoQ29ubmVjdDogRnVuY3Rpb247XG4gIHB1c2hTdWJzY3JpYmU6IEZ1bmN0aW9uO1xuICBwdXNoVW5zdWJzY3JpYmU6IEZ1bmN0aW9uO1xuICBwdXNoQ3JlYXRlOiBGdW5jdGlvbjtcbiAgcHVzaEVudGVyOiBGdW5jdGlvbjtcbiAgcHVzaFVwZGF0ZTogRnVuY3Rpb247XG4gIHB1c2hEZWxldGU6IEZ1bmN0aW9uO1xuICBwdXNoTGVhdmU6IEZ1bmN0aW9uO1xuXG4gIGNvbnN0cnVjdG9yKGlkOiBudW1iZXIsIHBhcnNlV2ViU29ja2V0OiBhbnksIGhhc01hc3RlcktleTogYm9vbGVhbikge1xuICAgIHRoaXMuaWQgPSBpZDtcbiAgICB0aGlzLnBhcnNlV2ViU29ja2V0ID0gcGFyc2VXZWJTb2NrZXQ7XG4gICAgdGhpcy5oYXNNYXN0ZXJLZXkgPSBoYXNNYXN0ZXJLZXk7XG4gICAgdGhpcy5yb2xlcyA9IFtdO1xuICAgIHRoaXMuc3Vic2NyaXB0aW9uSW5mb3MgPSBuZXcgTWFwKCk7XG4gICAgdGhpcy5wdXNoQ29ubmVjdCA9IHRoaXMuX3B1c2hFdmVudCgnY29ubmVjdGVkJyk7XG4gICAgdGhpcy5wdXNoU3Vic2NyaWJlID0gdGhpcy5fcHVzaEV2ZW50KCdzdWJzY3JpYmVkJyk7XG4gICAgdGhpcy5wdXNoVW5zdWJzY3JpYmUgPSB0aGlzLl9wdXNoRXZlbnQoJ3Vuc3Vic2NyaWJlZCcpO1xuICAgIHRoaXMucHVzaENyZWF0ZSA9IHRoaXMuX3B1c2hFdmVudCgnY3JlYXRlJyk7XG4gICAgdGhpcy5wdXNoRW50ZXIgPSB0aGlzLl9wdXNoRXZlbnQoJ2VudGVyJyk7XG4gICAgdGhpcy5wdXNoVXBkYXRlID0gdGhpcy5fcHVzaEV2ZW50KCd1cGRhdGUnKTtcbiAgICB0aGlzLnB1c2hEZWxldGUgPSB0aGlzLl9wdXNoRXZlbnQoJ2RlbGV0ZScpO1xuICAgIHRoaXMucHVzaExlYXZlID0gdGhpcy5fcHVzaEV2ZW50KCdsZWF2ZScpO1xuICB9XG5cbiAgc3RhdGljIHB1c2hSZXNwb25zZShwYXJzZVdlYlNvY2tldDogYW55LCBtZXNzYWdlOiBNZXNzYWdlKTogdm9pZCB7XG4gICAgbG9nZ2VyLnZlcmJvc2UoJ1B1c2ggUmVzcG9uc2UgOiAlaicsIG1lc3NhZ2UpO1xuICAgIHBhcnNlV2ViU29ja2V0LnNlbmQobWVzc2FnZSk7XG4gIH1cblxuICBzdGF0aWMgcHVzaEVycm9yKFxuICAgIHBhcnNlV2ViU29ja2V0OiBhbnksXG4gICAgY29kZTogbnVtYmVyLFxuICAgIGVycm9yOiBzdHJpbmcsXG4gICAgcmVjb25uZWN0OiBib29sZWFuID0gdHJ1ZVxuICApOiB2b2lkIHtcbiAgICBDbGllbnQucHVzaFJlc3BvbnNlKFxuICAgICAgcGFyc2VXZWJTb2NrZXQsXG4gICAgICBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIG9wOiAnZXJyb3InLFxuICAgICAgICBlcnJvcjogZXJyb3IsXG4gICAgICAgIGNvZGU6IGNvZGUsXG4gICAgICAgIHJlY29ubmVjdDogcmVjb25uZWN0LFxuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgYWRkU3Vic2NyaXB0aW9uSW5mbyhyZXF1ZXN0SWQ6IG51bWJlciwgc3Vic2NyaXB0aW9uSW5mbzogYW55KTogdm9pZCB7XG4gICAgdGhpcy5zdWJzY3JpcHRpb25JbmZvcy5zZXQocmVxdWVzdElkLCBzdWJzY3JpcHRpb25JbmZvKTtcbiAgfVxuXG4gIGdldFN1YnNjcmlwdGlvbkluZm8ocmVxdWVzdElkOiBudW1iZXIpOiBhbnkge1xuICAgIHJldHVybiB0aGlzLnN1YnNjcmlwdGlvbkluZm9zLmdldChyZXF1ZXN0SWQpO1xuICB9XG5cbiAgZGVsZXRlU3Vic2NyaXB0aW9uSW5mbyhyZXF1ZXN0SWQ6IG51bWJlcik6IHZvaWQge1xuICAgIHJldHVybiB0aGlzLnN1YnNjcmlwdGlvbkluZm9zLmRlbGV0ZShyZXF1ZXN0SWQpO1xuICB9XG5cbiAgX3B1c2hFdmVudCh0eXBlOiBzdHJpbmcpOiBGdW5jdGlvbiB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uKHN1YnNjcmlwdGlvbklkOiBudW1iZXIsIHBhcnNlT2JqZWN0SlNPTjogYW55KTogdm9pZCB7XG4gICAgICBjb25zdCByZXNwb25zZTogTWVzc2FnZSA9IHtcbiAgICAgICAgb3A6IHR5cGUsXG4gICAgICAgIGNsaWVudElkOiB0aGlzLmlkLFxuICAgICAgfTtcbiAgICAgIGlmICh0eXBlb2Ygc3Vic2NyaXB0aW9uSWQgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgIHJlc3BvbnNlWydyZXF1ZXN0SWQnXSA9IHN1YnNjcmlwdGlvbklkO1xuICAgICAgfVxuICAgICAgaWYgKHR5cGVvZiBwYXJzZU9iamVjdEpTT04gIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgIGxldCBmaWVsZHM7XG4gICAgICAgIGlmICh0aGlzLnN1YnNjcmlwdGlvbkluZm9zLmhhcyhzdWJzY3JpcHRpb25JZCkpIHtcbiAgICAgICAgICBmaWVsZHMgPSB0aGlzLnN1YnNjcmlwdGlvbkluZm9zLmdldChzdWJzY3JpcHRpb25JZCkuZmllbGRzO1xuICAgICAgICB9XG4gICAgICAgIHJlc3BvbnNlWydvYmplY3QnXSA9IHRoaXMuX3RvSlNPTldpdGhGaWVsZHMocGFyc2VPYmplY3RKU09OLCBmaWVsZHMpO1xuICAgICAgfVxuICAgICAgQ2xpZW50LnB1c2hSZXNwb25zZSh0aGlzLnBhcnNlV2ViU29ja2V0LCBKU09OLnN0cmluZ2lmeShyZXNwb25zZSkpO1xuICAgIH07XG4gIH1cblxuICBfdG9KU09OV2l0aEZpZWxkcyhwYXJzZU9iamVjdEpTT046IGFueSwgZmllbGRzOiBhbnkpOiBGbGF0dGVuZWRPYmplY3REYXRhIHtcbiAgICBpZiAoIWZpZWxkcykge1xuICAgICAgcmV0dXJuIHBhcnNlT2JqZWN0SlNPTjtcbiAgICB9XG4gICAgY29uc3QgbGltaXRlZFBhcnNlT2JqZWN0ID0ge307XG4gICAgZm9yIChjb25zdCBmaWVsZCBvZiBkYWZhdWx0RmllbGRzKSB7XG4gICAgICBsaW1pdGVkUGFyc2VPYmplY3RbZmllbGRdID0gcGFyc2VPYmplY3RKU09OW2ZpZWxkXTtcbiAgICB9XG4gICAgZm9yIChjb25zdCBmaWVsZCBvZiBmaWVsZHMpIHtcbiAgICAgIGlmIChmaWVsZCBpbiBwYXJzZU9iamVjdEpTT04pIHtcbiAgICAgICAgbGltaXRlZFBhcnNlT2JqZWN0W2ZpZWxkXSA9IHBhcnNlT2JqZWN0SlNPTltmaWVsZF07XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBsaW1pdGVkUGFyc2VPYmplY3Q7XG4gIH1cbn1cblxuZXhwb3J0IHsgQ2xpZW50IH07XG4iXX0=